import ZoomableImage from '../../../components/ZoomableImage'
import ZoomableDiagram from './ZoomableDiagram'

&nbsp;

# 🧠 Yaci Store - Design

## 🏗️ High Level Design

Yaci Store is designed as a modular, event-driven blockchain indexing system for Cardano. It provides a pluggable architecture that allows developers to create scoped indexers with selective data processing capabilities.

### 🎯 Design Goals

- **Modularity**: Provide a Java library for creating scoped indexers
- **Selectivity**: Handle selective data indexing with filtering capabilities
- **Flexibility**: Allow behavior overrides and custom implementations
- **Reliability**: Manage rollbacks and ensure data consistency
- **Extensibility**: Support out-of-the-box applications and custom extensions

---

## 🏛️ Architecture Overview
<ZoomableImage src="/images/component-diagram.png" alt="High Level Design" />

### 🧱 Core Module

The core module is the backbone of Yaci Store. It serves as the primary interface between the Cardano blockchain and the indexing system.

**Key Responsibilities:**
- **Data Reading**: Connects to Cardano nodes and reads blockchain data
- **Event Broadcasting**: Publishes Spring events for processed blocks and transactions
- **State Management**: Tracks current processing point in the database
- **Rollback Handling**: Manages blockchain reorganizations and rollbacks

---

### 🏬 Stores

Each store is a specialized module designed for a specific data type or use case. Stores operate independently but can communicate through events.

**Store Capabilities:**
- **Event Listening**: Subscribe to events from the core module
- **Data Processing**: Transform raw blockchain data into structured formats
- **Persistence**: Store processed data in the database
- **Event Publishing**: Publish derived events for other components (optional)
- **REST Endpoints**: Provide API access to stored data (optional)

**Available Stores in v0.1.x:**

| Store Name | Description | Spring Boot Starter | Status |
|------------|-------------|---------------------|--------|
| **Block Store** | Processes block headers and metadata | `yaci-store-block-spring-boot-starter` | ✅ Available |
| **Transaction Store** | Handles transaction data and metadata | `yaci-store-transaction-spring-boot-starter` | ✅ Available |
| **UTxO Store** | Manages unspent transaction outputs | `yaci-store-utxo-spring-boot-starter` | ✅ Available |
| **Staking Store** | Processes staking-related data | `yaci-store-staking-spring-boot-starter` | ✅ Available |
| **Script Store** | Manages smart contract scripts | `yaci-store-script-spring-boot-starter` | ✅ Available |
| **Epoch Store** | Handles epoch-related data | `yaci-store-epoch-spring-boot-starter` | ✅ Available |
| **Assets Store** | Manages native tokens and NFTs | `yaci-store-assets-spring-boot-starter` | ✅ Available |
| **Governance Store** | Processes governance-related data (voting, proposals) | `yaci-store-governance-spring-boot-starter` | ✅ Available |
| **Metadata Store** | Stores transaction metadata | `yaci-store-metadata-spring-boot-starter` | ✅ Available |
| **MIR Store** | Processes Move Instantaneous Rewards certificates | `yaci-store-mir-spring-boot-starter` | ✅ Available |

> ⚠️ **Note**: The Governance Store functionality might not be complete in v0.1.x and may have limited features compared to the full v2.0.0 implementation.

> 💡 **Note**: To simplify rollback handling, stores do not perform data aggregation directly.

---

### 📊 Aggregates

Aggregates handle complex data aggregation across multiple stores. They are responsible for creating derived data that requires information from multiple sources.

**Features:**
- **Cross-Store Data**: Aggregate data from multiple stores
- **Snapshot-Based**: Store data snapshots for efficient rollback handling
- **Event-Driven**: React to events from multiple stores
- **Experimental Status**: Currently in experimental phase

**Available Aggregates:**
- **Account Aggregate**: Provides account balance and transaction history
  - Depends on UTxO Store events
  - Maintains balance snapshots per slot
  - Supports efficient balance queries

---

### 💾 Persistence Layer

The persistence layer provides flexible data storage options with automatic schema management.

**Database Support:**
- **PostgreSQL**: Recommended for production use
- **MySQL**: Alternative production database
- **H2**: Lightweight option for development and testing

**Features:**
- **Auto-Schema Generation**: Flyway manages database schema evolution
- **Custom Storage**: Implement custom storage backends via Storage API
- **Rollback Support**: Slot-based rollback mechanism
- **Migration Support**: Automatic schema migrations

---

### 📤 Transaction Submission

The submit module enables transaction submission directly to Cardano nodes.

**Submission Methods:**
- **N2C Protocol**: Direct node-to-client communication
- **Submit API**: HTTP-based transaction submission
- **Local Node**: Submit to local Cardano node
- **Remote Node**: Submit to remote Cardano node

---

## 🧩 Stores - Components

### 🧬 Store Design
<ZoomableImage src="/images/store-design.png" alt="Store Design" />

A store is composed of the following components:

#### ⚙️ 1. Processor

A processor is responsible for processing data. It listens to events published by the core module and processes the data contained in the event. A processor can also publish derived events. For example: UtxoProcessor in the utxo store listens to TransactionEvent and processes the UTxOs contained in the transaction. It also publishes AddressUtxo derived event for each UTxO.

Developer can write their own processor by listening to events published by the core module.

#### 💽 2. Storage

A storage defines the interface for storing data. The implementation of a storage api is responsible for storing data in a persistent store. By default, Yaci Store uses a relational database to store data and each store provides a default implementation of corresponding storage api using JPA.

This can be overridden by developers by implementing the storage api in consuming applications.

#### 🌐 3. Controller

A controller provides REST endpoints to retrieve store's data. It uses the storage api to retrieve data from the persistent store. Out of the box, Yaci Store provides some common REST endpoints for all stores. But, developers can implement their own REST endpoints.

---

## 🪃 Handling Rollbacks

Yaci Store follows a simply strategy to handle rollbacks. As store modules don't handle any data aggregation, the rollback handling becomes simple. Each table in a store maintains a slot column. When a processor received a RollbackEvent event, it deletes all the records with a slot greater than the rollback slot mentioned in the event.

But as aggregates handle data aggregation, the rollback handling becomes a bit complex. But with a simple strategy, we can handle rollbacks in aggregates as well. For example, the Account module aggregates account balance. But instead of storing the account balance for an address in one record, balance snapshot is stored for a slot. As we don't update existing records during aggregation, rollback can be handled by simply deleting all the records with a slot greater than the rollback slot mentioned in the event.

If you are using Yaci Store as a library in your application with your own domain model and tables, you can follow the similar strategy to handle rollbacks.

---

## 🔁 Idempotency

Though Yaci Store ensures that the same event is not published more than once, it is possible that the same event is published more than once in some scenarios. All out-of-box modules are idempotent. But if you are writing your own stores, you should make sure that your modules are idempotent.

---

## 🧵 Sequential Block Processing
<ZoomableImage src="/images/store-sequential-diagram.png" alt="Sequential Processing" />

<div style={{
  display: 'grid',
  gridTemplateColumns: '1fr',
  gap: '2rem',
  marginTop: '1rem'
}}>

<div>

- Cardano Node → Publisher emits per-block events: Block Header, Transaction, Mint/Burn, Script, AuxData, Update, Governance.
- Stores consume these events in order and persist to their own tables.

</div>

</div>

---

## 🧶 Parallel Block Processing

<ZoomableImage src="/images/store-parallel-diagram.png" alt="Parallel Processing" />

<div style={{
  display: 'grid',
  gridTemplateColumns: '1fr',
  gap: '2rem',
  marginTop: '1rem'
}}>

<div>

- Publisher groups blocks into batches processed on multiple threads, each batch emits events .
- Stores consume batches concurrently and write to storage

</div>

</div>
