&nbsp;

# 🔄 Upgrade Guide: v0.1.x to v2.0.0

This guide helps you upgrade from Yaci Store v0.1.x to v2.0.0, covering breaking changes, new features, and step-by-step upgrade process.

---

## 🎯 Upgrade Overview

### Key Changes in v2.0.0
- **Java 21+ Required**: Virtual threads and performance optimizations
- **Ledger State Support**: Full ledger state with governance and rewards
- **Multi-language Plugins**: Plugin framework supporting different languages
- **Configuration Updates**: New configuration format and options
- **Database Schema Changes**: Updated schema for new features

### Before You Start
- **Backup your data**: Full database backup recommended
- **Plan downtime**: Migration typically takes 2-4 hours
- **Test environment**: Validate migration in test environment first

---

## 📋 Pre-Migration Checklist

### System Requirements
- [ ] **Java 21+** installed ([Download Oracle JDK 21](https://www.oracle.com/java/technologies/downloads/))
- [ ] **8-16 GB RAM** available for migration process
- [ ] **Sufficient disk space** (2x current database size recommended)
- [ ] **PostgreSQL 14+** (if using PostgreSQL)

### Data Preparation
- [ ] **Complete current sync** to avoid data inconsistencies
- [ ] **Create full database backup**
- [ ] **Document current configuration** settings
- [ ] **Stop all v0.1.x instances**

```bash
# Create database backup
pg_dump -h localhost -U yaci_user yaci_db > yaci_v1_backup.sql

# Stop v0.1.x instance
systemctl stop yaci-store
# or
docker-compose down
```

---

## 🔧 Configuration Upgrade

### 1. Update Application Properties

#### v0.1.x Configuration
```properties
# Old format
store.cardano.host=localhost
store.cardano.port=3001
store.cardano.protocol-magic=764824073

# Database
spring.datasource.url=jdbc:postgresql://localhost:5432/yaci_db
spring.datasource.username=yaci_user
spring.datasource.password=password123

# Stores
store.blocks.enabled=true
store.transactions.enabled=true
store.utxos.enabled=true
```

#### v2.0.0 Configuration
```yaml
# New YAML format
yaci:
  store:
    cardano:
      host: localhost
      port: 3001
      protocol-magic: 764824073
      network: mainnet
    
    # Enhanced database configuration
    datasource:
      url: jdbc:postgresql://localhost:5432/yaci_db
      username: yaci_user
      password: password123
      hikari:
        maximum-pool-size: 20
        minimum-idle: 5
    
    # Updated store configuration
    stores:
      blocks:
        enabled: true
        batch-size: 1000
      transactions:
        enabled: true
        include-cbor: false
      utxos:
        enabled: true
        pruning-enabled: false
      
      # New stores in v2.0.0
      governance:
        enabled: true
      rewards:
        enabled: true
      ledger-state:
        enabled: false
```

### 2. Environment Variables

```bash
# v0.1.x
CARDANO_NODE_HOST=localhost
CARDANO_NODE_PORT=3001

# v2.0.0 - Updated naming
YACI_STORE_CARDANO_HOST=localhost
YACI_STORE_CARDANO_PORT=3001
YACI_STORE_NETWORK=mainnet
```

---

## 🗄️ Database Migration

### Option 1: Fresh Sync (Recommended)
Start with a clean database and resync from genesis.

```bash
# 1. Create new database
createdb -h localhost -U postgres yaci_v2_db

# 2. Download v2.0.0
# Get the latest version from: https://github.com/bloxbean/yaci-store/releases/tag/v2.0.0-beta3

# 3. Start with new configuration
# Download and use the appropriate jar from the beta3 release
java -jar yaci-store-all-2.0.0-beta3.jar --spring.config.location=application-v2.yml
```

### Option 2: Data Migration (Advanced)
Migrate existing data with schema updates.

```bash
# 1. Backup current database
pg_dump yaci_db > v1_backup.sql

# 2. Create v2 database
createdb yaci_v2_db

# 3. Run migration scripts (provided with v2.0.0)
psql -d yaci_v2_db -f migration-scripts/v1-to-v2-schema.sql
psql -d yaci_v2_db -f migration-scripts/v1-to-v2-data.sql

# 4. Verify migration
psql -d yaci_v2_db -c "SELECT COUNT(*) FROM block;"
```

---

## 🚀 Deployment Migration

### Docker Compose Migration

#### v0.1.x Docker Compose
```yaml
version: '3.8'
services:
  yaci-store:
    image: bloxbean/yaci-store:0.1.4
    environment:
      - CARDANO_NODE_HOST=cardano-node
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/yaci_db
    depends_on:
      - postgres
```

#### v2.0.0 Docker Compose
```yaml
version: '3.8'
services:
  yaci-store:
    image: bloxbean/yaci-store:2.0.0-beta3
    environment:
      - YACI_STORE_CARDANO_HOST=cardano-node
      - YACI_STORE_CARDANO_NETWORK=mainnet
      - YACI_STORE_DATASOURCE_URL=jdbc:postgresql://postgres:5432/yaci_v2_db
    volumes:
      - ./config/application.yml:/app/application.yml
    depends_on:
      - postgres
  
  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: yaci_v2_db
      POSTGRES_USER: yaci_user
      POSTGRES_PASSWORD: password123
    volumes:
      - postgres_data:/var/lib/postgresql/data
    shm_size: 2g  # Important for v2.0.0 performance

volumes:
  postgres_data:
```

---

## 🔌 API Migration

### REST API Changes

#### v0.1.x API Endpoints
```bash
# Block endpoints
GET /api/v1/blocks
GET /api/v1/blocks/{hash}

# Transaction endpoints  
GET /api/v1/transactions
GET /api/v1/transactions/{hash}
```

#### v2.0.0 API Endpoints
```bash
# Enhanced block endpoints
GET /api/v2/blocks
GET /api/v2/blocks/{hash}
GET /api/v2/blocks/{hash}/transactions

# Enhanced transaction endpoints
GET /api/v2/transactions
GET /api/v2/transactions/{hash}
GET /api/v2/transactions/{hash}/utxos

# New governance endpoints
GET /api/v2/governance/proposals
GET /api/v2/governance/votes
GET /api/v2/governance/drep-registrations

# New rewards endpoints
GET /api/v2/rewards/epochs/{epoch}
GET /api/v2/rewards/accounts/{stake_address}
```

### API Response Changes

#### Updated Response Format
```json
// v0.1.x response
{
  "hash": "abc123",
  "number": 12345,
  "slot": 67890
}

// v2.0.0 response (enhanced)
{
  "hash": "abc123", 
  "number": 12345,
  "slot": 67890,
  "epoch": 123,
  "era": "Conway",
  "governance_actions": [],
  "_metadata": {
    "version": "2.0.0",
    "indexed_at": "2024-01-01T12:00:00Z"
  }
}
```

---

## 🧪 Testing Migration

### Validation Steps

```bash
# 1. Verify Java version
java -version  # Should show 21+

# 2. Test database connection
psql -h localhost -U yaci_user -d yaci_v2_db -c "SELECT version();"

# 3. Validate API endpoints
curl http://localhost:8080/api/v2/blocks?page=0&size=1

# 4. Check governance data (new in v2.0.0)
curl http://localhost:8080/api/v2/governance/proposals

# 5. Monitor sync progress
curl http://localhost:8080/actuator/health
```

### Performance Validation
```bash
# Check memory usage
curl http://localhost:8080/actuator/metrics/jvm.memory.used

# Monitor sync lag
curl http://localhost:8080/actuator/metrics/yaci.store.sync.lag

# Database query performance
time curl "http://localhost:8080/api/v2/blocks?page=0&size=100"
```

---

## 🔥 Rollback Plan

If migration fails, follow these steps:

### 1. Stop v2.0.0 Instance
```bash
systemctl stop yaci-store
# or
docker-compose down
```

### 2. Restore v0.1.x Database
```bash
# Drop v2 database
dropdb yaci_v2_db

# Restore v1 backup
createdb yaci_db
psql yaci_db < v1_backup.sql
```

### 3. Restart v0.1.x
```bash
# Restore v0.1.x configuration
cp application-v1.properties.backup application.properties

# Start v0.1.x instance
java -jar yaci-store-all-0.1.4.jar
```

---

## 🎯 Post-Migration

### 1. Monitor Performance
- **Sync lag**: Should be < 30 seconds
- **Memory usage**: Monitor JVM heap usage
- **Database performance**: Query response times

### 2. Update Integration Code
- **API endpoints**: Update to v2 API format
- **Response parsing**: Handle new response structure
- **Error handling**: Update for new error codes

### 3. Enable New Features
```yaml
# Enable governance indexing
yaci:
  store:
    stores:
      governance:
        enabled: true
        include-drep-data: true
      
      rewards:
        enabled: true
        calculate-delegator-rewards: true
      
      ledger-state:
        enabled: true  # Enable for full ledger state
```


