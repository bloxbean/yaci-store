&nbsp;

# üß© Context Variables

Complete reference for all context variables available to your plugins, enabling powerful integrations without deep Java knowledge.

---

## üîç Overview

Every plugin execution context provides access to **6 core variables** plus any **custom variable providers** you've configured. These variables enable database access, HTTP communication, configuration management, and state persistence.

---

## üìä Core Context Variables

### 1. üóÑÔ∏è `jdbc` - Database Access

**Type:** `JdbcTemplate`  
**Description:** Spring JDBC template for database operations

#### Basic Queries

```javascript
// Simple query
const count = jdbc.queryForObject(
    "SELECT COUNT(*) FROM tx WHERE block_number > ?", 
    [8000000]
);

// Query with multiple parameters  
const transactions = jdbc.queryForList(
    "SELECT tx_hash, fee FROM tx WHERE block_number BETWEEN ? AND ? ORDER BY fee DESC LIMIT ?",
    [8000000, 8001000, 10]
);

// Single row query
const transaction = jdbc.queryForMap(
    "SELECT * FROM tx WHERE tx_hash = ?",
    ['abc123...']
);
```

#### Insert/Update Operations

```javascript
// Insert single record
jdbc.update(
    "INSERT INTO custom_metrics (block_number, tx_count, created_at) VALUES (?, ?, ?)",
    [blockNumber, txCount, new Date()]
);

// Update records
const updated = jdbc.update(
    "UPDATE custom_flags SET processed = true WHERE block_number = ?",
    [blockNumber]
);

console.log(`Updated ${updated} records`);

// Delete records  
jdbc.update(
    "DELETE FROM temp_data WHERE created_at < ?",
    [cutoffDate]
);
```

#### Batch Operations

```javascript
// Batch insert for performance
const batchData = [
    [hash1, amount1, address1],
    [hash2, amount2, address2],
    [hash3, amount3, address3]
];

jdbc.batchUpdate(
    "INSERT INTO utxo_analysis (tx_hash, amount, address) VALUES (?, ?, ?)",
    batchData
);
```

---

### 2. üìù `named_jdbc` - Named Parameter JDBC

**Type:** `NamedParameterJdbcTemplate`  
**Description:** JDBC template with named parameters for cleaner queries

```javascript
// Named parameters (cleaner than positional)
const result = named_jdbc.queryForList(
    "SELECT * FROM tx WHERE block_number = :blockNum AND fee > :minFee",
    {
        blockNum: 8000000,
        minFee: 200000
    }
);

// Complex named query
const metadata = named_jdbc.queryForList(`
    SELECT tm.*, t.block_number, t.block_time 
    FROM tx_metadata tm 
    JOIN tx t ON tm.tx_hash = t.hash 
    WHERE tm.label = :label 
      AND t.block_number BETWEEN :startBlock AND :endBlock
      AND tm.json::text LIKE :pattern
    ORDER BY t.block_time DESC
    LIMIT :maxResults
`, {
    label: '721',
    startBlock: 8000000,
    endBlock: 8100000,
    pattern: '%"image"%',
    maxResults: 100
});

// Named batch operations
const namedBatch = [
    { hash: 'abc123', status: 'processed', updatedAt: new Date() },
    { hash: 'def456', status: 'processed', updatedAt: new Date() }
];

named_jdbc.batchUpdate(
    "UPDATE transaction_status SET status = :status, updated_at = :updatedAt WHERE tx_hash = :hash",
    namedBatch
);
```

---

### 3. üåê `http` - HTTP Client

**Type:** `HttpClient`  
**Description:** HTTP client for external API calls and webhooks

#### GET Requests

```javascript
// Simple GET
const response = http.get('https://api.example.com/cardano/price');
const priceData = JSON.parse(response.body);

// GET with headers
const response = http.get('https://api.github.com/user', {
    headers: {
        'Authorization': 'token ghp_xxxxxxxxxxxx',
        'Accept': 'application/vnd.github.v3+json'
    }
});

// GET with query parameters
const response = http.get('https://api.example.com/search', {
    params: {
        q: 'cardano',
        limit: 10,
        offset: 0
    }
});
```

#### POST Requests

```javascript
// JSON POST
const webhookData = {
    event: 'new_block',
    blockNumber: blockNumber,
    timestamp: new Date().toISOString(),
    transactionCount: txCount
};

const response = http.post('https://webhook.example.com/cardano-events', {
    headers: {
        'Content-Type': 'application/json',
        'X-API-Key': env.getProperty('webhook.apiKey')
    },
    body: JSON.stringify(webhookData)
});

// Form data POST
http.post('https://api.example.com/submit', {
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: 'name=value&other=data'
});

// File upload (if supported)
http.post('https://api.example.com/upload', {
    headers: { 'Content-Type': 'multipart/form-data' },
    files: { 'file': fileData }
});
```

#### Error Handling

```javascript
try {
    const response = http.get('https://api.unreliable.com/data');
    
    if (response.status === 200) {
        const data = JSON.parse(response.body);
        return processData(data);
    } else {
        console.error(`HTTP error: ${response.status} - ${response.body}`);
    }
} catch (error) {
    console.error(`Request failed: ${error.message}`);
    
    // Log to database for monitoring
    jdbc.update(
        "INSERT INTO http_errors (url, error_msg, created_at) VALUES (?, ?, ?)",
        ['https://api.unreliable.com/data', error.message, new Date()]
    );
}
```

---

### 4. ‚öôÔ∏è `env` - Environment & Configuration

**Type:** `Environment`  
**Description:** Access to application properties and environment variables

#### Property Access

```javascript
// Get property with default
const maxRetries = env.getProperty('plugin.http.maxRetries', '3');
const apiKey = env.getProperty('external.api.key');

// Type-specific getters
const timeout = env.getProperty('plugin.timeout', '30000', 'java.lang.Integer');
const enabled = env.getProperty('plugin.notifications.enabled', 'false', 'java.lang.Boolean');

// Environment-specific config
const isDev = env.getProperty('spring.profiles.active', '').includes('dev');
const dbUrl = env.getProperty('spring.datasource.url');

// Custom plugin configuration
const pluginConfig = {
    batchSize: env.getProperty('plugin.myPlugin.batchSize', '100'),
    endpoint: env.getProperty('plugin.myPlugin.endpoint'),
    retryDelay: env.getProperty('plugin.myPlugin.retryDelay', '5000')
};
```

#### Dynamic Configuration

```javascript
function adaptiveProcessor(data, context) {
    // Adjust behavior based on environment
    const profile = env.getProperty('spring.profiles.active', 'production');
    
    if (profile.includes('dev')) {
        // Verbose logging in development
        console.log(`Processing: ${JSON.stringify(data)}`);
        return processWithLogging(data);
    } else if (profile.includes('prod')) {
        // Optimized processing in production
        return processOptimized(data);
    }
    
    // Default processing
    return processDefault(data);
}
```

---

### 5. üåç `global_state` - Global State Storage  

**Type:** `Map<String, Object>`  
**Description:** Shared state accessible across all plugin instances

#### Global Counters

```javascript
// Initialize if needed
if (!global_state.totalTransactions) {
    global_state.totalTransactions = 0;
    global_state.totalFees = 0;
    global_state.startTime = Date.now();
}

// Update global metrics
global_state.totalTransactions++;
global_state.totalFees += transaction.fee;

// Log milestones
if (global_state.totalTransactions % 10000 === 0) {
    const duration = Date.now() - global_state.startTime;
    const rate = global_state.totalTransactions / (duration / 1000);
    
    console.log(`Processed ${global_state.totalTransactions} transactions at ${rate.toFixed(2)} tx/sec`);
    
    // Store milestone in database
    jdbc.update(
        "INSERT INTO processing_milestones (tx_count, avg_rate, total_fees, timestamp) VALUES (?, ?, ?, ?)",
        [global_state.totalTransactions, rate, global_state.totalFees, new Date()]
    );
}
```

#### Global Caches

```javascript
// Address lookup cache
if (!global_state.addressCache) {
    global_state.addressCache = new Map();
}

function resolveAddressType(address) {
    // Check cache first
    if (global_state.addressCache.has(address)) {
        return global_state.addressCache.get(address);
    }
    
    // Resolve and cache
    const type = determineAddressType(address);
    global_state.addressCache.set(address, type);
    
    // Limit cache size
    if (global_state.addressCache.size > 10000) {
        const firstKey = global_state.addressCache.keys().next().value;
        global_state.addressCache.delete(firstKey);
    }
    
    return type;
}
```

#### Global Configuration

```javascript
// Share configuration across plugins
if (!global_state.sharedConfig) {
    global_state.sharedConfig = {
        highValueThreshold: 1000 * 1000000, // 1000 ADA in lovelace
        monitoredPolicies: ['policy1...', 'policy2...'],
        webhookEndpoints: ['https://webhook1.com', 'https://webhook2.com']
    };
}

// Use shared config
function processTransaction(tx, context) {
    const config = global_state.sharedConfig;
    
    if (tx.totalOutput > config.highValueThreshold) {
        // Notify all configured webhooks
        config.webhookEndpoints.forEach(endpoint => {
            http.post(endpoint, { body: JSON.stringify(tx) });
        });
    }
}
```

---

### 6. üè† `state` - Local Plugin State

**Type:** `Map<String, Object>`  
**Description:** Private state for each plugin instance

#### Processing State

```javascript
// Initialize plugin state
if (!state.initialized) {
    state.processed = 0;
    state.errors = 0;
    state.lastProcessedBlock = 0;
    state.batchBuffer = [];
    state.initialized = true;
}

// Track processing
state.processed++;
state.lastProcessedBlock = Math.max(state.lastProcessedBlock, data.blockNumber);

// Batch processing
state.batchBuffer.push(data);

if (state.batchBuffer.length >= 50) {
    processBatch(state.batchBuffer);
    state.batchBuffer = [];
}
```

#### Plugin Statistics

```javascript
function trackStatistics(data, context) {
    // Initialize stats
    if (!state.stats) {
        state.stats = {
            startTime: Date.now(),
            itemCounts: {},
            errorsByType: {},
            performanceMetrics: []
        };
    }
    
    // Track item types
    const type = data.type || 'unknown';
    state.stats.itemCounts[type] = (state.stats.itemCounts[type] || 0) + 1;
    
    // Performance tracking
    const startTime = Date.now();
    const result = processItem(data);
    const duration = Date.now() - startTime;
    
    state.stats.performanceMetrics.push({
        type: type,
        duration: duration,
        timestamp: Date.now()
    });
    
    // Keep only recent metrics (last 1000)
    if (state.stats.performanceMetrics.length > 1000) {
        state.stats.performanceMetrics.shift();
    }
    
    // Periodic reporting
    if (state.processed % 1000 === 0) {
        reportStatistics(state.stats);
    }
    
    return result;
}
```

---

## üîß Custom Variable Providers

Extend the context with your own variables by creating Java-based providers.

### Creating a Custom Provider

```java
@Component
public class CustomVariableProvider implements PluginContextVariableProvider {
    
    @Override
    public Map<String, Object> getVariables() {
        Map<String, Object> variables = new HashMap<>();
        
        // Custom services
        variables.put("tokenService", new TokenLookupService());
        variables.put("priceOracle", new PriceOracleService());
        variables.put("validator", new TransactionValidator());
        
        // Utility objects
        variables.put("dateUtils", new DateUtilities());
        variables.put("cryptoUtils", new CryptoUtilities());
        
        return variables;
    }
    
    @Override
    public String getProviderName() {
        return "custom-services";
    }
}
```

### Using Custom Variables

```javascript
// Use your custom services in plugins
function enrichedProcessor(transaction, context) {
    // Use custom token service
    const tokens = tokenService.getTokensInTransaction(transaction);
    
    // Get price data
    const adaPrice = priceOracle.getPrice('ADA', 'USD');
    
    // Validate transaction
    const isValid = validator.validateTransaction(transaction);
    
    // Format dates
    const formattedTime = dateUtils.formatTimestamp(transaction.blockTime);
    
    // Encrypt sensitive data
    const encryptedData = cryptoUtils.encrypt(JSON.stringify(transaction));
    
    // Store enriched data
    jdbc.update(`
        INSERT INTO enriched_transactions 
        (tx_hash, token_count, ada_price_usd, is_valid, formatted_time, encrypted_data) 
        VALUES (?, ?, ?, ?, ?, ?)
    `, [
        transaction.hash,
        tokens.length,
        adaPrice,
        isValid,
        formattedTime,
        encryptedData
    ]);
    
    return true;
}
```

---

## üéØ Best Practices

### 1. üîÑ State Management

```javascript
// Good: Initialize state properly
function initializeState() {
    if (!state.initialized) {
        state.counters = {};
        state.cache = new Map();
        state.config = loadConfiguration();
        state.initialized = true;
    }
}

// Good: Clean up resources
function cleanupState() {
    // Periodic cleanup
    if (state.processed % 10000 === 0) {
        // Clear old cache entries
        if (state.cache.size > 1000) {
            state.cache.clear();
        }
        
        // Archive old data
        archiveOldData(state);
    }
}
```

### 2. üåê HTTP Best Practices  

```javascript
// Good: Reusable HTTP function with retry logic
function httpWithRetry(url, options = {}, maxRetries = 3) {
    let lastError;
    
    for (let i = 0; i < maxRetries; i++) {
        try {
            return http.get(url, options);
        } catch (error) {
            lastError = error;
            
            // Exponential backoff
            const delay = Math.pow(2, i) * 1000;
            java.lang.Thread.sleep(delay);
            
            console.log(`HTTP retry ${i + 1}/${maxRetries} after ${delay}ms delay`);
        }
    }
    
    throw lastError;
}

// Good: Rate limiting
function rateLimitedRequest(url, options) {
    // Simple rate limiting using state
    const now = Date.now();
    const lastRequest = state.lastHttpRequest || 0;
    const minInterval = 1000; // 1 second between requests
    
    if (now - lastRequest < minInterval) {
        const delay = minInterval - (now - lastRequest);
        java.lang.Thread.sleep(delay);
    }
    
    state.lastHttpRequest = Date.now();
    return http.get(url, options);
}
```

### 3. üìä Database Optimization

```javascript
// Good: Connection-aware queries
function optimizedDatabaseAccess(data, context) {
    // Batch similar operations
    if (!state.insertBatch) {
        state.insertBatch = [];
    }
    
    state.insertBatch.push(data);
    
    // Process batch when full or on cleanup
    if (state.insertBatch.length >= 100 || shouldFlush(context)) {
        jdbc.batchUpdate(
            "INSERT INTO processed_data (hash, data, created_at) VALUES (?, ?, ?)",
            state.insertBatch.map(item => [item.hash, JSON.stringify(item), new Date()])
        );
        
        state.insertBatch = [];
    }
}

// Good: Query caching
function cachedQuery(query, params, cacheKey) {
    // Check cache first
    if (state.queryCache && state.queryCache.has(cacheKey)) {
        const cached = state.queryCache.get(cacheKey);
        
        // Check cache age (5 minutes)
        if (Date.now() - cached.timestamp < 300000) {
            return cached.result;
        }
    }
    
    // Execute query
    const result = jdbc.queryForList(query, params);
    
    // Cache result
    if (!state.queryCache) {
        state.queryCache = new Map();
    }
    
    state.queryCache.set(cacheKey, {
        result: result,
        timestamp: Date.now()
    });
    
    return result;
}
```

### 4. üîß Configuration Management

```javascript
// Good: Centralized config loading
function loadPluginConfig() {
    if (!global_state.pluginConfigs) {
        global_state.pluginConfigs = {};
    }
    
    const pluginName = 'my-plugin';
    
    if (!global_state.pluginConfigs[pluginName]) {
        global_state.pluginConfigs[pluginName] = {
            enabled: env.getProperty(`plugin.${pluginName}.enabled`, 'true') === 'true',
            batchSize: parseInt(env.getProperty(`plugin.${pluginName}.batchSize`, '50')),
            timeout: parseInt(env.getProperty(`plugin.${pluginName}.timeout`, '30000')),
            endpoints: env.getProperty(`plugin.${pluginName}.endpoints`, '').split(',').filter(e => e.trim()),
            features: {
                logging: env.getProperty(`plugin.${pluginName}.features.logging`, 'false') === 'true',
                monitoring: env.getProperty(`plugin.${pluginName}.features.monitoring`, 'false') === 'true'
            }
        };
    }
    
    return global_state.pluginConfigs[pluginName];
}
```

---

Ready to configure your plugins? Check out the [Plugin Configuration Guide](./plugin-configuration)! ‚öôÔ∏è