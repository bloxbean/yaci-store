&nbsp;

# ‚öôÔ∏è Plugin Configuration

Complete guide to configuring plugins, managing plugin lifecycles, and optimizing plugin performance in Yaci Store.

---

## üèóÔ∏è Configuration Overview

Plugin configuration in Yaci Store operates on multiple levels:

1. **Global Plugin Settings** - Framework-wide configuration
2. **Plugin Discovery** - How plugins are found and loaded  
3. **Individual Plugin Config** - Per-plugin settings
4. **Runtime Configuration** - Dynamic configuration management

---

## üåê Global Plugin Configuration

### Enable Plugin Framework

Add to `application.yml`:

```yaml
yaci:
  store:
    plugins:
      enabled: true                    # Enable plugin framework
      autoDiscovery: true             # Auto-discover plugins
      loadOnStartup: true             # Load plugins at startup
      parallelExecution: true         # Enable parallel plugin execution
      maxThreads: 10                  # Max threads for plugin execution
      executionTimeout: 30000         # Plugin execution timeout (ms)
      
      # Plugin locations
      locations:
        - "/opt/yaci-plugins"         # System plugin directory
        - "./plugins"                 # Local plugin directory  
        - "classpath:plugins"         # Classpath plugins
      
      # Security settings
      security:
        restrictFileAccess: true      # Restrict file system access
        allowNetworkAccess: true      # Allow HTTP requests
        maxMemoryPerPlugin: "128MB"   # Memory limit per plugin
        
      # Language-specific settings  
      javascript:
        enabled: true
        engineOptions: "--js.ecmascript-version=2022"
      python:
        enabled: true
        allowNativeExtensions: false  # Restrict native libraries
      mvel:
        enabled: true
```

### Properties File Configuration

Alternative configuration via `application.properties`:

```properties
# Plugin Framework
yaci.store.plugins.enabled=true
yaci.store.plugins.autoDiscovery=true
yaci.store.plugins.locations=/opt/yaci-plugins,./plugins

# Execution Settings
yaci.store.plugins.parallelExecution=true
yaci.store.plugins.maxThreads=10
yaci.store.plugins.executionTimeout=30000

# Security
yaci.store.plugins.security.restrictFileAccess=true
yaci.store.plugins.security.allowNetworkAccess=true
yaci.store.plugins.security.maxMemoryPerPlugin=128MB

# Language Settings
yaci.store.plugins.javascript.enabled=true
yaci.store.plugins.python.enabled=true
yaci.store.plugins.python.allowNativeExtensions=false
```

---

## üìÇ Plugin Discovery

### Directory-Based Discovery

```yaml
yaci:
  store:
    plugins:
      locations:
        - "/opt/yaci-plugins"      # System-wide plugins
        - "./plugins"              # Application plugins
        - "~/.yaci/plugins"        # User plugins
```

**Expected Structure:**
```
/opt/yaci-plugins/
‚îú‚îÄ‚îÄ my-filter-plugin/
‚îÇ   ‚îú‚îÄ‚îÄ plugin.yml
‚îÇ   ‚îú‚îÄ‚îÄ filter.js
‚îÇ   ‚îî‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ analytics-plugin/
‚îÇ   ‚îú‚îÄ‚îÄ plugin.yml
‚îÇ   ‚îú‚îÄ‚îÄ analytics.py
‚îÇ   ‚îî‚îÄ‚îÄ requirements.txt
‚îî‚îÄ‚îÄ governance-monitor/
    ‚îú‚îÄ‚îÄ plugin.yml  
    ‚îî‚îÄ‚îÄ monitor.java
```

### Classpath Discovery

```yaml
yaci:
  store:
    plugins:
      locations:
        - "classpath:plugins"
        - "classpath:custom-plugins"
```

**JAR Structure:**
```
my-app.jar
‚îú‚îÄ‚îÄ BOOT-INF/
‚îÇ   ‚îî‚îÄ‚îÄ classes/
‚îÇ       ‚îî‚îÄ‚îÄ plugins/
‚îÇ           ‚îú‚îÄ‚îÄ builtin-filter/
‚îÇ           ‚îÇ   ‚îú‚îÄ‚îÄ plugin.yml
‚îÇ           ‚îÇ   ‚îî‚îÄ‚îÄ filter.js
‚îÇ           ‚îî‚îÄ‚îÄ default-logger/
‚îÇ               ‚îú‚îÄ‚îÄ plugin.yml
‚îÇ               ‚îî‚îÄ‚îÄ logger.py
```

---

## üìã Plugin Descriptor (`plugin.yml`)

### Basic Plugin Configuration

```yaml
# Plugin Metadata
name: metadata-filter                 # Unique plugin name
version: 1.2.0                       # Plugin version
description: "Filter metadata by labels"
author: "Your Name <email@example.com>"
license: "MIT"
homepage: "https://github.com/user/plugin"

# Plugin Type & Language
type: storage                         # storage | event-handler | combined
language: javascript                 # javascript | python | mvel | java

# Plugin Dependencies
dependencies:
  yaciStore: ">=2.0.0"              # Minimum Yaci Store version
  plugins:                          # Plugin dependencies
    - "base-utilities@1.0.0"

# Configuration Schema
config:
  properties:
    batchSize:
      type: integer
      default: 50
      description: "Batch size for processing"
    endpoint:
      type: string
      required: true
      description: "Webhook endpoint URL"
    labels:
      type: array
      items:
        type: string
      default: ["721", "20"]
      description: "Metadata labels to process"

# Storage Plugin Hooks
hooks:
  - extensionPoint: "metadata.save"
    type: "filter"
    script: "metadata-filter.js"
    enabled: true
    order: 100                        # Execution order (lower = earlier)
    
  - extensionPoint: "metadata.save"  
    type: "post-action"
    script: "metadata-logger.js"
    enabled: true
    conditions:                       # Conditional execution
      - "env.getProperty('logging.enabled') == 'true'"

# Event Handler Configuration (if type: event-handler)
events:
  - event: "BlockEvent"
    script: "block-handler.js"
    enabled: true
    async: true                       # Async execution
    
  - event: "TransactionEvent"
    script: "tx-handler.py"
    enabled: true
    conditions:
      - "event.transaction.fee > 1000000"  # Only high-fee transactions

# Resource Requirements
resources:
  memory: "64MB"                      # Memory limit
  cpu: 0.5                           # CPU limit (cores)
  timeout: 30000                     # Execution timeout (ms)

# Environment Requirements  
environment:
  java: ">=11"
  python: ">=3.8"                    # If using Python
  
# Plugin-specific settings
settings:
  retryCount: 3
  retryDelay: 1000
  enableCaching: true
  logLevel: "INFO"
```

### Advanced Plugin Configuration

```yaml
# Multi-script plugin
name: comprehensive-analyzer
type: combined
language: javascript

# Multiple hooks
hooks:
  # Transaction analysis
  - extensionPoint: "transaction.save"
    type: "pre-action"
    script: "scripts/tx-analyzer.js"
    order: 10
    
  # UTXO processing  
  - extensionPoint: "utxo.unspent.save"
    type: "filter"
    script: "scripts/utxo-filter.js"
    order: 20
    conditions:
      - "data.amount[0].quantity > 1000000"  # Only high-value UTXOs
      
  # Metadata enrichment
  - extensionPoint: "metadata.save"
    type: "pre-action" 
    script: "scripts/metadata-enricher.js"
    order: 30

# Event handlers
events:
  - event: "BlockEvent"
    script: "scripts/block-analytics.js"
    async: true
    
  - event: "EpochEvent"
    script: "scripts/epoch-summary.js"
    async: false

# Dynamic configuration
config:
  properties:
    analysisMode:
      type: string
      enum: ["basic", "advanced", "full"]
      default: "basic"
    thresholds:
      type: object
      properties:
        highValue:
          type: integer
          default: 10000000
        suspiciousPattern:
          type: string
          default: ".*[Pp]onzi.*"
    notifications:
      type: object
      properties:
        slack:
          type: object
          properties:
            webhook: 
              type: string
              format: uri
            channel:
              type: string
              default: "#alerts"
        email:
          type: object
          properties:
            smtp:
              type: string
            recipients:
              type: array
              items:
                type: string
                format: email

# Environment-specific overrides
profiles:
  development:
    settings:
      logLevel: "DEBUG"
      enableVerboseLogging: true
    hooks:
      - extensionPoint: "transaction.save"
        script: "scripts/debug-tx.js"
        order: 1
        
  production:
    settings:
      logLevel: "WARN"
      enableOptimizations: true
    resources:
      memory: "256MB"
      timeout: 60000
```

---

## üîß Runtime Configuration

### Application-Level Plugin Settings

```yaml
# Override individual plugins
yaci:
  store:
    plugins:
      # Global settings
      enabled: true
      
      # Per-plugin configuration
      instances:
        metadata-filter:
          enabled: true
          config:
            batchSize: 100
            labels: ["721", "20", "222"]
            endpoint: "https://webhook.production.com"
            
        analytics-plugin:
          enabled: false              # Disable specific plugin
          
        governance-monitor:
          enabled: true
          config:
            notifications:
              slack:
                webhook: "${SLACK_WEBHOOK_URL}"
                channel: "#governance-alerts"
              email:
                smtp: "${SMTP_SERVER}"
                recipients: 
                  - "admin@example.com"
                  - "governance@example.com"
```

### Environment Variable Configuration

```bash
# Plugin framework settings
YACI_STORE_PLUGINS_ENABLED=true
YACI_STORE_PLUGINS_MAX_THREADS=20

# Plugin-specific settings
YACI_STORE_PLUGINS_METADATA_FILTER_BATCH_SIZE=200
YACI_STORE_PLUGINS_METADATA_FILTER_ENDPOINT=https://prod-webhook.com

# Security settings
YACI_STORE_PLUGINS_SECURITY_MAX_MEMORY_PER_PLUGIN=256MB
YACI_STORE_PLUGINS_SECURITY_EXECUTION_TIMEOUT=45000
```

### Dynamic Configuration Updates

```javascript
// Plugin can access dynamic configuration
function processData(data, context) {
    // Get current configuration
    const config = context.getPluginConfig();
    
    // Configuration can change during runtime
    const batchSize = config.batchSize || 50;
    const endpoint = config.endpoint;
    
    // Check if configuration changed
    if (!state.lastConfig || state.lastConfig.batchSize !== batchSize) {
        console.log(`Configuration updated: batchSize = ${batchSize}`);
        state.lastConfig = config;
        
        // Adjust processing accordingly
        resizeBatchBuffer(batchSize);
    }
    
    return processWithConfig(data, config);
}
```

---

## üìä Plugin Management

### Plugin Lifecycle Management

```yaml
# Plugin lifecycle hooks
yaci:
  store:
    plugins:
      lifecycle:
        onLoad: "scripts/plugin-init.js"        # Run when plugin loads
        onEnable: "scripts/plugin-enable.js"    # Run when plugin enables  
        onDisable: "scripts/plugin-disable.js"  # Run when plugin disables
        onUnload: "scripts/plugin-cleanup.js"   # Run when plugin unloads
```

#### Lifecycle Hook Examples

```javascript
// scripts/plugin-init.js - Run once when plugin loads
function onPluginLoad(context) {
    console.log("Plugin loading...");
    
    // Initialize plugin resources
    initializeDatabase(context);
    loadConfiguration(context);
    
    // Set up global state
    global_state.pluginStartTime = Date.now();
    
    return true;
}

// scripts/plugin-enable.js - Run when plugin is enabled
function onPluginEnable(context) {
    console.log("Plugin enabled");
    
    // Start background tasks
    startPeriodicTasks(context);
    
    // Register with external services
    registerWebhooks(context);
    
    return true;
}

// scripts/plugin-disable.js - Run when plugin is disabled
function onPluginDisable(context) {
    console.log("Plugin disabled");
    
    // Stop background tasks
    stopPeriodicTasks();
    
    // Cleanup resources
    cleanupConnections();
    
    return true;
}

// scripts/plugin-cleanup.js - Run when plugin unloads
function onPluginUnload(context) {
    console.log("Plugin unloading...");
    
    // Final cleanup
    flushPendingData(context);
    closeResources();
    
    // Remove from external services
    unregisterWebhooks();
    
    return true;
}
```

### Plugin Status & Monitoring

```javascript
// Built-in plugin monitoring
function monitorPlugin(data, context) {
    // Access plugin metrics
    const metrics = context.getPluginMetrics();
    
    console.log(`Plugin Statistics:
        Total Executions: ${metrics.totalExecutions}
        Success Rate: ${(metrics.successRate * 100).toFixed(2)}%
        Average Duration: ${metrics.averageExecutionTime}ms
        Memory Usage: ${metrics.memoryUsage}MB
        Last Error: ${metrics.lastError || 'None'}
    `);
    
    // Custom health checks
    const isHealthy = checkPluginHealth(context);
    
    if (!isHealthy) {
        // Report health issues
        reportHealthIssue(context, metrics);
    }
    
    return true;
}
```

---

## üîí Security Configuration

### Sandbox Settings

```yaml
yaci:
  store:
    plugins:
      security:
        # File system restrictions
        restrictFileAccess: true
        allowedPaths:
          - "/tmp/plugin-data"
          - "/opt/plugin-resources"
        
        # Network restrictions  
        allowNetworkAccess: true
        allowedHosts:
          - "api.cardano.org"
          - "webhook.example.com"
        blockedHosts:
          - "localhost"
          - "127.0.0.1"
          
        # Resource limits
        maxMemoryPerPlugin: "128MB"
        maxCpuPerPlugin: 0.5
        maxExecutionTime: 30000
        
        # Code restrictions
        restrictReflection: true      # Block Java reflection
        restrictSystemCalls: true    # Block system calls
        allowUnsafeOperations: false # Block unsafe operations
```

### Permission-Based Security

```yaml
# Plugin permissions
name: secure-plugin
permissions:
  database:
    read: ["tx", "block", "metadata"]    # Allowed read tables
    write: ["custom_analytics"]         # Allowed write tables
    
  network:
    hosts: ["api.cardano.org"]          # Allowed hosts
    ports: [80, 443]                   # Allowed ports
    
  system:
    properties: ["java.version"]        # Allowed system properties
    environment: ["HOME", "PATH"]       # Allowed env variables
    
  resources:
    maxMemory: "64MB"
    maxCpuTime: 10000                  # Max CPU time (ms)
    maxFileSize: "10MB"                # Max file operations
```

---

## üöÄ Performance Optimization

### Execution Optimization

```yaml
yaci:
  store:
    plugins:
      performance:
        # Threading
        parallelExecution: true
        maxConcurrentPlugins: 10
        threadPoolSize: 20
        
        # Caching
        enableCompilationCache: true     # Cache compiled scripts
        maxCacheSize: 1000
        
        # Batching
        enableBatching: true
        defaultBatchSize: 50
        maxBatchSize: 1000
        
        # Optimization
        enableJitCompilation: true       # JIT for frequent scripts
        optimizeMemoryUsage: true
        
        # Monitoring
        enableMetrics: true
        metricsInterval: 60000          # Metrics collection interval
```

### Language-Specific Optimization

```yaml
# JavaScript optimization
yaci:
  store:
    plugins:
      javascript:
        engineOptions: 
          - "--js.ecmascript-version=2022"
          - "--js.optimize"
          - "--js.strict"
        enableCompilation: true
        cacheCompiledScripts: true
        
      # Python optimization  
      python:
        interpreterOptions:
          - "-O"                       # Optimize
          - "-B"                       # No .pyc files
        enableJit: true
        cacheCompiledCode: true
        isolateExecutions: true        # Separate interpreters
```

### Memory Management

```yaml
yaci:
  store:
    plugins:
      memory:
        # Garbage collection
        forceGcInterval: 300000        # Force GC every 5 minutes
        maxHeapPerPlugin: "128MB"
        
        # Object pooling
        enableObjectPooling: true
        maxPoolSize: 1000
        
        # Memory monitoring
        enableMemoryProfiling: true
        memoryAlertThreshold: 0.8      # Alert at 80% usage
```

---

## üîß Development Configuration

### Development Mode Settings

```yaml
# Development profile
spring:
  profiles:
    active: development

yaci:
  store:
    plugins:
      development:
        # Enhanced debugging
        enableDebugMode: true
        verboseLogging: true
        logExecutionTime: true
        
        # Hot reloading
        enableHotReload: true
        watchDirectories: 
          - "./plugins"
        reloadInterval: 5000
        
        # Testing
        enableTestMode: true
        mockExternalCalls: true
        
        # Validation
        strictValidation: true
        validateOnLoad: true
```

### Debug Configuration

```yaml
# Debugging settings
logging:
  level:
    com.bloxbean.cardano.yaci.store.plugins: DEBUG
    com.bloxbean.cardano.yaci.store.plugins.execution: TRACE

yaci:
  store:
    plugins:
      debug:
        enableTracing: true
        traceExecutionPaths: true
        logContextVariables: true
        captureStackTraces: true
        
        # Debug output
        debugOutputDir: "./debug/plugins"
        captureInputOutput: true
        generateExecutionReports: true
```

---

## üìà Monitoring & Metrics

### Metrics Collection

```yaml
yaci:
  store:
    plugins:
      metrics:
        enabled: true
        
        # Built-in metrics
        collectExecutionMetrics: true
        collectMemoryMetrics: true
        collectPerformanceMetrics: true
        
        # Export configuration
        prometheus:
          enabled: true
          endpoint: "/actuator/prometheus"
          
        jmx:
          enabled: true
          domain: "yaci.store.plugins"
          
        # Custom metrics
        customMetrics:
          - name: "plugin_business_metric"
            type: "counter"
            description: "Custom business metric"
```

### Health Checks

```yaml
management:
  health:
    plugins:
      enabled: true
      
  endpoint:
    health:
      show-details: always

yaci:
  store:
    plugins:
      health:
        # Health check configuration
        enableHealthChecks: true
        healthCheckInterval: 30000
        
        # Failure thresholds
        maxConsecutiveFailures: 3
        failureTimeWindow: 300000      # 5 minutes
        
        # Auto-recovery
        enableAutoRecovery: true
        recoveryAttempts: 3
        recoveryDelay: 60000
```

---

## üéØ Best Practices

### 1. Configuration Organization

```yaml
# Organized configuration structure
yaci:
  store:
    plugins:
      # Framework settings
      enabled: true
      autoDiscovery: true
      
      # Global defaults
      defaults:
        timeout: 30000
        memory: "64MB"
        logLevel: "INFO"
      
      # Environment-specific
      profiles:
        development:
          defaults:
            timeout: 60000
            logLevel: "DEBUG"
        production:  
          defaults:
            timeout: 15000
            logLevel: "WARN"
            
      # Plugin-specific settings
      instances:
        high-priority-plugin:
          order: 1
          resources:
            memory: "256MB"
            timeout: 60000
```

### 2. Secure Configuration Management

```yaml
# Use external configuration for sensitive data
yaci:
  store:
    plugins:
      instances:
        webhook-notifier:
          config:
            # Reference external properties
            apiKey: "${WEBHOOK_API_KEY:}"
            endpoint: "${WEBHOOK_ENDPOINT:https://default.com}"
            
        database-exporter:
          config:
            connection:
              url: "${EXPORT_DB_URL}"
              username: "${EXPORT_DB_USER}"
              password: "${EXPORT_DB_PASSWORD}"
```

### 3. Progressive Configuration

```yaml
# Start simple, add complexity as needed
yaci:
  store:
    plugins:
      # Phase 1: Basic setup
      enabled: true
      locations: ["./plugins"]
      
      # Phase 2: Add performance tuning
      # parallelExecution: true
      # maxThreads: 10
      
      # Phase 3: Add security
      # security:
      #   restrictFileAccess: true
      
      # Phase 4: Add monitoring  
      # metrics:
      #   enabled: true
```

---

Your plugin framework is now fully configured! üéâ Ready to dive into advanced plugin development patterns and explore real-world use cases.