&nbsp;

# 📊 Monitoring and Observability

**New in v2.0.0-beta3**: Yaci Store now includes built-in monitoring capabilities with Prometheus metrics and Grafana dashboards for comprehensive production observability.

<div style={{
  background: 'linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(16, 185, 129, 0.1) 100%)',
  padding: '1rem',
  borderRadius: '8px',
  border: '1px solid rgba(34, 197, 94, 0.2)',
  marginBottom: '1.5rem'
}}>

🆕 **What's New**: This is a major enhancement in v2.0.0-beta3. Previous versions (beta1) only had basic logging capabilities.

</div>

---

## 🎯 Overview

Yaci Store v2.0.0-beta3 provides enterprise-grade monitoring out of the box:

- **📈 Prometheus Metrics**: 50+ built-in metrics for performance tracking
- **📊 Grafana Dashboards**: Pre-built dashboards for visualization  
- **🔍 Health Checks**: Application and database health monitoring
- **⚡ Performance Metrics**: Real-time indexing and query performance
- **🏛️ Governance Tracking**: Conway era governance data monitoring
- **💾 Resource Utilization**: Memory, CPU, and storage monitoring

---

## 🚀 Quick Setup

### Docker Compose with Monitoring Stack

```yaml
version: '3.8'

services:
  # Yaci Store with monitoring enabled
  yaci-store:
    image: bloxbean/yaci-store:2.0.0-beta3
    environment:
      # Enable monitoring endpoints
      MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE: "health,info,metrics,prometheus"
      MANAGEMENT_ENDPOINT_PROMETHEUS_ENABLED: "true"
      MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS: "always"
      
      # Enhanced governance tracking (beta3 feature)
      STORE_GOVERNANCE_ENABLED: "true"
      STORE_GOVERNANCE_PROPOSAL_TRACKING: "true"
    ports:
      - "8080:8080"
    depends_on:
      - postgres
    networks:
      - yaci-network

  # PostgreSQL database
  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: yaci_store
      POSTGRES_USER: yaci
      POSTGRES_PASSWORD: changeme
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - yaci-network

  # Prometheus metrics collection
  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=30d'
      - '--web.enable-lifecycle'
    networks:
      - yaci-network

  # Grafana dashboards
  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_PASSWORD: admin
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./grafana/datasources:/etc/grafana/provisioning/datasources
    networks:
      - yaci-network

volumes:
  postgres_data:
  prometheus_data:
  grafana_data:

networks:
  yaci-network:
```

### Prometheus Configuration

Create `prometheus.yml`:

```yaml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  # - "first_rules.yml"
  # - "second_rules.yml"

scrape_configs:
  - job_name: 'yaci-store'
    static_configs:
      - targets: ['yaci-store:8080']
    metrics_path: '/actuator/prometheus'
    scrape_interval: 30s
    
  - job_name: 'postgres'
    static_configs:
      - targets: ['postgres:9187']
    scrape_interval: 30s
```

---

## 📊 Available Metrics

### 🔍 Core Application Metrics

| Metric Family | Description | Key Metrics |
|--------------|-------------|-------------|
| **`yaci_store_blocks`** | Block processing metrics | `yaci_store_blocks_processed_total`, `yaci_store_blocks_processing_duration` |
| **`yaci_store_transactions`** | Transaction indexing | `yaci_store_transactions_processed_total`, `yaci_store_transactions_failed_total` |
| **`yaci_store_sync`** | Synchronization status | `yaci_store_sync_current_slot`, `yaci_store_sync_lag_seconds` |
| **`yaci_store_database`** | Database operations | `yaci_store_database_query_duration`, `yaci_store_database_connections_active` |

### 🏛️ Governance Metrics (New in beta3)

| Metric | Description | Labels |
|--------|-------------|---------|
| **`yaci_store_governance_proposals_total`** | Total governance proposals by type | `type`, `status`, `epoch` |
| **`yaci_store_governance_votes_total`** | Governance votes counted | `proposal_id`, `vote_type`, `epoch` |
| **`yaci_store_drep_distribution`** | DRep stake distribution accuracy | `network`, `epoch`, `drep_id` |
| **`yaci_store_treasury_reserves`** | Treasury and reserves tracking | `type`, `epoch`, `accuracy_percentage` |

### 💾 Resource Metrics

| Metric | Description | Purpose |
|--------|-------------|---------|
| **`jvm_memory_used_bytes`** | JVM memory usage by pool | Memory monitoring |
| **`jvm_gc_pause_seconds`** | Garbage collection performance | GC optimization |
| **`process_cpu_usage`** | CPU utilization percentage | Resource planning |
| **`hikaricp_connections`** | Database connection pool | Connection optimization |

---

## 📈 Pre-built Grafana Dashboards

### Yaci Store Overview Dashboard

Create `grafana/dashboards/yaci-store-overview.json`:

```json
{
  "dashboard": {
    "id": null,
    "title": "Yaci Store Overview",
    "tags": ["yaci-store", "cardano"],
    "timezone": "browser",
    "panels": [
      {
        "id": 1,
        "title": "Block Processing Rate",
        "type": "stat",
        "targets": [
          {
            "expr": "rate(yaci_store_blocks_processed_total[5m])",
            "legendFormat": "Blocks/sec"
          }
        ],
        "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0}
      },
      {
        "id": 2,
        "title": "Sync Lag",
        "type": "stat",
        "targets": [
          {
            "expr": "yaci_store_sync_lag_seconds",
            "legendFormat": "Lag (seconds)"
          }
        ],
        "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0}
      },
      {
        "id": 3,
        "title": "Transaction Processing",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(yaci_store_transactions_processed_total[5m])",
            "legendFormat": "Processed/sec"
          },
          {
            "expr": "rate(yaci_store_transactions_failed_total[5m])",
            "legendFormat": "Failed/sec"
          }
        ],
        "gridPos": {"h": 8, "w": 24, "x": 0, "y": 8}
      }
    ],
    "time": {
      "from": "now-1h",
      "to": "now"
    },
    "refresh": "5s"
  }
}
```

### Governance Dashboard (beta3 Feature)

Create `grafana/dashboards/yaci-store-governance.json`:

```json
{
  "dashboard": {
    "id": null,
    "title": "Yaci Store Governance Tracking",
    "tags": ["yaci-store", "governance", "conway"],
    "panels": [
      {
        "id": 1,
        "title": "Governance Proposals by Type",
        "type": "piechart",
        "targets": [
          {
            "expr": "yaci_store_governance_proposals_total",
            "legendFormat": "{{type}}"
          }
        ]
      },
      {
        "id": 2,
        "title": "DRep Distribution Accuracy",
        "type": "stat",
        "targets": [
          {
            "expr": "avg(yaci_store_drep_distribution)",
            "legendFormat": "Accuracy %"
          }
        ]
      },
      {
        "id": 3,
        "title": "Treasury/Reserves Accuracy",
        "type": "graph",
        "targets": [
          {
            "expr": "yaci_store_treasury_reserves{type=\"treasury\"}",
            "legendFormat": "Treasury Accuracy"
          },
          {
            "expr": "yaci_store_treasury_reserves{type=\"reserves\"}",
            "legendFormat": "Reserves Accuracy"
          }
        ]
      }
    ]
  }
}
```

---

## 🔍 Health Checks

### Application Health Endpoints

Yaci Store provides comprehensive health checks:

```bash
# Overall application health
curl http://localhost:8080/actuator/health

# Database connectivity health
curl http://localhost:8080/actuator/health/db

# Cardano node connectivity health  
curl http://localhost:8080/actuator/health/cardano-node

# Detailed health with components
curl http://localhost:8080/actuator/health/details
```

### Sample Health Response

```json
{
  "status": "UP",
  "components": {
    "db": {
      "status": "UP",
      "details": {
        "database": "PostgreSQL",
        "validationQuery": "isValid()"
      }
    },
    "cardanoNode": {
      "status": "UP",
      "details": {
        "connectionType": "ogmios",
        "currentSlot": 115234567,
        "syncProgress": 99.98
      }
    },
    "governance": {
      "status": "UP",
      "details": {
        "epochSupport": {
          "mainnet": 569,
          "preprod": 227,
          "preview": 989
        },
        "accuracyPercentage": 99.98
      }
    }
  }
}
```

---

## ⚠️ Alerting Rules

### Prometheus Alerting Rules

Create `prometheus-alerts.yml`:

```yaml
groups:
  - name: yaci-store-alerts
    rules:
      - alert: YaciStoreSyncLag
        expr: yaci_store_sync_lag_seconds > 300
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Yaci Store sync lag is high"
          description: "Sync lag is {{ $value }} seconds, which is above the 5 minute threshold"

      - alert: YaciStoreBlockProcessingStalled
        expr: rate(yaci_store_blocks_processed_total[5m]) == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Block processing has stalled"
          description: "No blocks have been processed in the last 5 minutes"

      - alert: YaciStoreGovernanceAccuracyLow
        expr: avg(yaci_store_drep_distribution) < 95
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Governance accuracy below threshold"
          description: "DRep distribution accuracy is {{ $value }}%, below 95% threshold"

      - alert: YaciStoreHighMemoryUsage
        expr: (jvm_memory_used_bytes{area="heap"} / jvm_memory_max_bytes{area="heap"}) > 0.9
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High JVM memory usage"
          description: "JVM heap usage is {{ $value | humanizePercentage }}"
```

---

## 🛠️ Configuration

### Application Properties

```properties
# Monitoring configuration (beta3)
management.endpoints.web.exposure.include=health,info,metrics,prometheus
management.endpoint.prometheus.enabled=true
management.endpoint.health.show-details=always
management.endpoint.health.show-components=always

# Metrics export configuration
management.prometheus.metrics.export.enabled=true
management.prometheus.metrics.export.step=30s

# Enhanced governance tracking (beta3)
store.governance.enabled=true
store.governance.proposal-tracking=true
store.governance.metrics.enabled=true

# Performance metrics
store.metrics.block-processing=true
store.metrics.transaction-processing=true
store.metrics.database-operations=true

# Custom metric tags
management.metrics.tags.application=yaci-store
management.metrics.tags.environment=${ENVIRONMENT:dev}
management.metrics.tags.version=2.0.0-beta3
```

### Environment Variables

```bash
# Docker environment variables
MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE=health,info,metrics,prometheus
MANAGEMENT_ENDPOINT_PROMETHEUS_ENABLED=true
MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS=always

# Governance tracking (beta3 feature)
STORE_GOVERNANCE_ENABLED=true
STORE_GOVERNANCE_PROPOSAL_TRACKING=true
STORE_GOVERNANCE_METRICS_ENABLED=true

# Custom tags
MANAGEMENT_METRICS_TAGS_ENVIRONMENT=production
MANAGEMENT_METRICS_TAGS_REGION=us-east-1
```

---

## 📋 Best Practices

### 🎯 Production Deployment

1. **Resource Monitoring**: Set up alerts for memory, CPU, and disk usage
2. **Sync Monitoring**: Monitor sync lag and block processing rates
3. **Database Monitoring**: Track query performance and connection pools
4. **Governance Accuracy**: Monitor DRep distribution and treasury calculations (beta3)
5. **Error Tracking**: Alert on failed transactions and processing errors

### 🔒 Security Considerations

```yaml
# Secure Grafana configuration
grafana:
  environment:
    GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD}
    GF_USERS_ALLOW_SIGN_UP: "false"
    GF_AUTH_ANONYMOUS_ENABLED: "false"
    GF_SECURITY_SECRET_KEY: ${GRAFANA_SECRET_KEY}
```

### 📈 Performance Optimization

```properties
# Optimize metrics collection
management.prometheus.metrics.export.step=60s
management.metrics.distribution.percentiles.http.server.requests=0.5,0.95,0.99
management.metrics.distribution.sla.http.server.requests=50ms,100ms,200ms,500ms
```

---

## 🐛 Troubleshooting

### Common Issues

| Issue | Symptom | Solution |
|-------|---------|----------|
| **Metrics not appearing** | Prometheus shows no data | Check `/actuator/prometheus` endpoint accessibility |
| **High memory usage** | JVM heap warnings | Tune JVM parameters: `-Xmx8g -XX:+UseG1GC` |
| **Sync lag increasing** | Lag metric rising | Check Cardano node connectivity and performance |
| **Governance metrics missing** | No governance data | Ensure `store.governance.enabled=true` (beta3 feature) |

### Debug Commands

```bash
# Check metrics endpoint
curl http://localhost:8080/actuator/prometheus | grep yaci_store

# Verify health status
curl http://localhost:8080/actuator/health | jq .

# Check JVM metrics
curl http://localhost:8080/actuator/metrics/jvm.memory.used

# Governance metrics (beta3)
curl http://localhost:8080/actuator/metrics/yaci_store_governance_proposals_total
```

---

> 🎯 **Next Steps**: 
> - Set up alerts based on your specific SLAs
> - Customize dashboards for your use case
> - Integrate with your existing monitoring infrastructure
> - Review [Performance Tuning](/gettingStarted/requirements#performance-optimization) for optimization tips