&nbsp;

# 🛠️ Chain Indexer Troubleshooting

This guide covers common issues when running Yaci Store as a standalone chain indexer (Spring Boot application) and their solutions.

## 🔗 Yaci Store as a Chain Indexer (Spring Boot App)

### 1. 🔄 Sync Not Starting Automatically

**Symptoms**: 
- Application starts successfully but shows no block syncing activity
- Logs show "Sync auto-start is disabled" message
- Block height remains at 0 or doesn't increase

**Root Causes**:
- Auto-sync is disabled in configuration
- Node connectivity issues
- Incorrect network configuration
- Node not fully synced

**Solutions**:

1. **Enable Auto-Sync**:
   ```properties
   store.sync-auto-start=true
   ```

2. **Verify Node Connection**:
   ```properties
   # For Ogmios
   ogmios.url=ws://localhost:1337
   
   # For Node-to-Client (Unix socket)
   n2c.socket-path=/path/to/cardano-node/socket
   n2c.host=localhost
   n2c.port=3001
   ```

3. **Check Node Status**:
   - Ensure Cardano node is fully synced
   - Verify node accepts connections on configured port
   - Test connectivity: `telnet localhost 3001`

4. **Network Configuration**:
   ```properties
   # Mainnet (default)
   store.cardano.network=mainnet
   
   # Preprod testnet
   store.cardano.network=preprod
   
   # Preview testnet  
   store.cardano.network=preview
   ```

**Verification**:
- Check logs for "Sync started" message
- Monitor block height progression in database
- Use `/api/v1/blocks/latest` endpoint to verify syncing

---

### 2. 💾 High Disk Usage

**Symptoms**:
- PostgreSQL database grows beyond expected size
- Disk space warnings or out-of-space errors
- Performance degradation due to large tables

**Root Causes**:
- Pruning disabled or misconfigured
- Large transaction history accumulation
- UTXO set growth without cleanup
- Missing vacuum/analyze maintenance

**Solutions**:

1. **Enable UTXO Pruning**:
   ```properties
   store.utxo.pruning-enabled=true
   store.utxo.pruning.interval=600
   # Keep last 2160 blocks (~1 day)
   store.utxo.pruning.blocks-behind=2160
   ```

2. **Enable Transaction Pruning**:
   ```properties
   store.transaction.pruning-enabled=true
   store.transaction.pruning.interval=3600
   # Keep last 43200 blocks (~30 days)
   store.transaction.pruning.blocks-behind=43200
   ```

3. **Database Maintenance**:
   ```sql
   -- Run periodically to reclaim space
   VACUUM ANALYZE;
   
   -- For aggressive cleanup
   VACUUM FULL;
   ```

4. **Storage Optimization**:
   ```properties
   # Disable unnecessary stores
   store.blocks.enabled=true
   store.transactions.enabled=true
   store.utxos.enabled=true
   store.rewards.enabled=false  # If not needed
   store.governance.enabled=false  # If not needed
   ```

**Monitoring**:
- Check database size: `SELECT pg_size_pretty(pg_database_size('yaci_store'));`
- Monitor table sizes: `SELECT schemaname,tablename,pg_size_pretty(pg_total_relation_size(tablename)) FROM pg_tables;`

---

### 3. 🧩 Only Some Stores Are Working

**Symptoms**:
- Expected data (rewards, governance, assets) is missing
- Only basic block/transaction data appears
- API endpoints return empty results for specific data types

**Root Causes**:
- Specific stores disabled in configuration
- Store initialization failures
- Database schema issues
- Version compatibility problems

**Solutions**:

1. **Enable Required Stores**:
   ```properties
   # Core stores
   store.blocks.enabled=true
   store.transactions.enabled=true
   store.utxos.enabled=true
   
   # Extended stores
   store.rewards.enabled=true
   store.governance.enabled=true
   store.assets.enabled=true
   store.metadata.enabled=true
   store.script.enabled=true
   store.multisig.enabled=true
   ```

2. **Check Initialization Logs**:
   ```bash
   # Look for store initialization errors
   tail -f logs/yaci-store.log | grep -i "store"
   ```

3. **Verify Database Schema**:
   ```sql
   -- Check if store tables exist
   SELECT table_name FROM information_schema.tables 
   WHERE table_schema = 'public' AND table_name LIKE '%reward%';
   ```

4. **Reset Specific Store** (if needed):
   ```properties
   # Force reset of governance store
   store.governance.reset-on-start=true
   ```

**Verification**:
- Check API endpoints: `/api/v1/rewards`, `/api/v1/governance`
- Verify table creation in database
- Monitor store-specific logs during startup

---

### 4. 🧠 Ledger State Mismatches

**Symptoms**:
- Rewards data differs from DB-Sync or official sources
- DRep information inconsistencies
- Governance proposal status discrepancies
- Treasury/reserves balance mismatches

**Root Causes**:
- Known issues with specific epochs or network events
- Incomplete sync or rollback handling
- Version-specific bugs
- Network-specific ledger state complexities

**Solutions**:

1. **Check Known Issues**:
   - Review [Known Issues → Ledger State Mismatch](/knownIssues/ledgerStateMismatch/overview)
   - Verify if your issue matches documented problems
   - Check for available patches or workarounds

2. **Force Resync** (if needed):
   ```properties
   # Reset from specific slot
   store.reset-on-start=true
   store.sync.start-slot=108000000
   ```

3. **Enable Ledger State Validation**:
   ```properties
   # Compare against node's ledger state (performance impact)
   store.ledger-state.validation-enabled=true
   ```

4. **Report New Issues**:
   - Document epoch, slot, tx hash, and affected addresses
   - Compare with DB-Sync or Koios API
   - Create detailed GitHub issue with reproduction steps

---

### 5. 🐘 PostgreSQL Performance Issues

**Symptoms**:
- Slow query response times
- Connection timeouts
- High CPU/memory usage on database server
- Sync process slowing down significantly

**Root Causes**:
- Insufficient PostgreSQL configuration
- Missing or suboptimal indexes
- Hardware resource constraints
- Large dataset without proper partitioning

**Solutions**:

1. **Docker/Container Optimization**:
   ```yaml
   # docker-compose.yml
   services:
     postgres:
       image: postgres:15
       shm_size: 2g
       environment:
         POSTGRES_SHARED_PRELOAD_LIBRARIES: pg_stat_statements
       command: |
         postgres -c shared_buffers=1GB
                  -c effective_cache_size=3GB
                  -c work_mem=64MB
                  -c maintenance_work_mem=512MB
                  -c max_connections=200
   ```

2. **Native PostgreSQL Configuration**:
   ```sql
   -- postgresql.conf optimizations
   shared_buffers = 1GB
   effective_cache_size = 3GB
   work_mem = 64MB
   maintenance_work_mem = 512MB
   max_connections = 200
   random_page_cost = 1.1  # For SSD
   checkpoint_segments = 32
   checkpoint_completion_target = 0.7
   ```

3. **Index Optimization**:
   ```sql
   -- Common performance indexes
   CREATE INDEX CONCURRENTLY idx_block_number ON block(block_number);
   CREATE INDEX CONCURRENTLY idx_tx_hash ON transaction(tx_hash);
   CREATE INDEX CONCURRENTLY idx_utxo_address ON address_utxo(address);
   CREATE INDEX CONCURRENTLY idx_epoch_rewards ON reward(epoch, address);
   ```

4. **Connection Pool Tuning**:
   ```properties
   # Application connection pool
   spring.datasource.hikari.maximum-pool-size=20
   spring.datasource.hikari.minimum-idle=5
   spring.datasource.hikari.connection-timeout=30000
   spring.datasource.hikari.idle-timeout=600000
   spring.datasource.hikari.max-lifetime=1800000
   ```

---

### 6. 🚦 Memory and Resource Issues

**Symptoms**:
- Out of memory errors
- Application crashes during sync
- Extremely slow processing
- High JVM heap usage

**Root Causes**:
- Insufficient JVM heap size
- Memory leaks in event processing
- Large batch sizes
- Multiple stores with high memory usage

**Solutions**:

1. **JVM Memory Configuration**:
   ```bash
   # Increase heap size
   java -Xmx8g -Xms2g -jar yaci-store.jar
   
   # Enable G1GC for better memory management
   java -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -jar yaci-store.jar
   ```

2. **Batch Processing Optimization**:
   ```properties
   store.batch-size=100
   store.parallel-processing=true
   store.worker-thread-count=4
   ```

3. **Selective Store Loading**:
   ```properties
   # Only enable essential stores
   store.blocks.enabled=true
   store.transactions.enabled=true
   store.utxos.enabled=true
   # Disable memory-intensive stores if not needed
   store.assets.enabled=false
   store.metadata.enabled=false
   ```

---

### 7. 🔄 Sync Recovery and Rollback Issues

**Symptoms**:
- Sync stops at specific block
- Data inconsistency after network rollback
- "Fork detected" errors
- Duplicate block processing errors

**Solutions**:

1. **Enable Rollback Handling**:
   ```properties
   store.rollback.enabled=true
   store.rollback.max-depth=2160
   ```

2. **Force Resync from Point**:
   ```properties
   store.reset-on-start=true
   store.sync.start-slot=107500000
   ```

3. **Monitor Rollback Events**:
   ```bash
   tail -f logs/yaci-store.log | grep -i "rollback"
   ```

---

### 8. 🌐 Network and Connectivity Issues

**Symptoms**:
- Intermittent connection drops
- "Connection refused" errors
- Sync stops unexpectedly
- High latency in block processing

**Solutions**:

1. **Connection Retry Configuration**:
   ```properties
   store.network.retry-attempts=5
   store.network.retry-delay=10000
   store.network.connection-timeout=30000
   ```

2. **Use Multiple Node Endpoints**:
   ```properties
   # Primary node
   ogmios.url=ws://node1.example.com:1337
   # Fallback configuration in application
   store.network.fallback-nodes=ws://node2.example.com:1337,ws://node3.example.com:1337
   ```

3. **Network Monitoring**:
   ```bash
   # Test node connectivity
   curl -I http://node.example.com:1337
   
   # Monitor connection stability
   ping -c 100 node.example.com
   ```

---
> 💬 **Still stuck?**
>
> - Ask questions on [Bloxbean Developers Discord](https://discord.gg/6AnKrFx4ne)& [GitHub Discussions](https://github.com/bloxbean/yaci-store/discussions) 
> - Report bugs via the [Issue Tracker](https://github.com/bloxbean/yaci-store/issues)  


