import { Callout } from 'nextra/components'

# Getting Started with Yaci Store 2.x.x

## Current Version: 2.0.0-beta5

This is the **latest beta release of Yaci Store with ledger-state support**. Yaci Store can now **calculate and derive ledger state**â€”such as **rewards**, **ADAPot**, and **governance state**â€”from **on-chain data**.

Unlike DB Sync, which receives ledger events directly from a local Cardano Node (both implemented in Haskell), **Yaci Store independently computes all required ledger state from the on-chain data itself.**

---

## Status of Ledger State Data Accuracy

Ledger State calculations include:
- Epoch Stake and Rewards
- ADAPot values
- Governance State (dRep distribution, Proposal Status, dRep Status)

### Reward Calculation and ADAPot Status

ADAPot values are matching for all 3 public networks up to the recent epochs:
- **Mainnet**: Up to epoch 595 (recent epoch when this document was written)
- **Preprod**: Up to epoch 253 (recent epoch when this document was written)
- **Preview**: Up to epoch 1121 (recent epoch when this document was written)

We will update this section with any discrepancies for future mismatches.

### Governance State Data

Governance action proposal statuses are correctly calculated up to recent epochs and are matching. However, there are some known mismatches in dRep distribution and dRep `active_until` values. For a detailed breakdown and the latest mismatch reports, see [the 2.0.0-beta5 mismatch summary](../../ledger-state-mismatches/2-0-0-beta5/2-0-0-beta5). We will be working on fixing these in future releases.

---

## Beta Release Status

Except for governance state and reward data, all other stores are production-ready and can be used in production environments.

While governance state data calculation has some mismatches, and even though reward/epoch stake data are all correct, we are keeping the beta label for now. There will be a few more beta releases while we fix all issues in the ledger state. Meanwhile, you can use other stores (UTXO, block, metadata, etc.) in production.

---

## Out-of-the-Box Applications

### 1. **Yaci Store App**
- The **default indexer application**, includes all modules.
- **Ledger-state calculation is disabled by default** but can be enabled via profile.

### 2. **Yaci Store Admin CLI App**
- CLI tool to **apply optional indexes after sync is complete**.
- Optional indexes improve API query performance and are not applied during initial sync.
- Supports rollback to a previous epoch

---

## Types of Distribution

Yaci Store provides three types of distributions:

1. **Yaci Store Docker Distribution**
2. **Yaci Store Zip Distribution (JARs)**
3. **Yaci Store Native (GraalVM) Distribution** *(Preview)*

---

### 1. Yaci Store Docker Distribution

This distribution provides scripts to help you easily run Yaci Store, perform administrative tasks, and monitor the system using Prometheus and Grafana.

The Docker distribution includes:
- PostgreSQL
- Yaci Store app
- Ledger State app
- Admin CLI tools
- Monitoring stack (Prometheus + Grafana)

#### ğŸ“¦ Contents

Key files and directories included:

```
.
â”œâ”€â”€ yaci-store.sh            # Start/stop Yaci Store application
â”œâ”€â”€ admin-cli.sh             # Admin operations (apply-indexes, rollback, etc.)
â”œâ”€â”€ monitoring.sh            # Start/stop Prometheus + Grafana monitoring stack
â”œâ”€â”€ compose/
â”‚   â”œâ”€â”€ .env                         # Environment file (contains Docker image tag)
â”‚   â”œâ”€â”€ yaci-store-monolith.yml      # Compose file for Yaci Store and PostgreSQL
â”‚   â”œâ”€â”€ admin-cli-compose.yml        # Compose file for admin CLI container
â”‚   â”œâ”€â”€ monitoring.yml               # Compose file for monitoring stack
â”‚   â””â”€â”€ ...
â”œâ”€â”€ config/                          # Yaci Store configuration files mounted inside the container
â”‚   â”œâ”€â”€ env                          # Environment file (e.g., to enable ledger-state profile)
â”‚   â”œâ”€â”€ application.properties
â”‚   â”œâ”€â”€ application-ledger-state.properties
â”‚   â”œâ”€â”€ application-plugins.yml
â”œâ”€â”€ plugin-scripts/          # Folder for custom plugin scripts (mounted inside the container)
â”œâ”€â”€ grafana/                 # Grafana configuration and dashboards
â”œâ”€â”€ prometheus/              # Prometheus configuration
```

#### ğŸ”§ Edit Configuration

Before starting Yaci Store, update the Cardano node connection details.

Edit the following values in `config/application.properties`:

```properties
store.cardano.host=preprod-node.world.dev.cardano.org
store.cardano.port=30000
store.cardano.protocol-magic=1
```

#### ğŸš€ Running Yaci Store

Use `yaci-store.sh` to start, stop, or view logs of the Yaci Store application.

##### âœ… Start

```bash
./yaci-store.sh start
```

This starts Yaci Store and PostgreSQL in the background.

* ğŸ“ Yaci Store API runs on **[http://localhost:8080](http://localhost:8080)**
* ğŸ“– API docs (Swagger UI): **[http://localhost:8080/swagger-ui/index.html](http://localhost:8080/swagger-ui/index.html)**

##### ğŸ›‘ Stop both Yaci Store and PostgreSQL

```bash
./yaci-store.sh stop
```

##### ğŸ›‘ Stop only Yaci Store (PostgreSQL stays running)

```bash
./yaci-store.sh stop:yaci-store
```

##### ğŸ“‹ View logs

```bash
./yaci-store.sh logs                # Logs from all containers
./yaci-store.sh logs:yaci-store     # Only Yaci Store logs
./yaci-store.sh logs:db             # Only PostgreSQL logs
```

#### âš™ï¸ Enable Ledger-State Profile

To run Yaci Store with the `ledger-state` profile:

1. Open the `env` file under the `config/` folder.
2. Uncomment or add the following line:

```env
SPRING_PROFILES_ACTIVE=ledger-state
```

3. Start the application:

```bash
./yaci-store.sh start
```

**If ledger state is enabled, verify the log message to ensure that ledger-state calculation is active**

While running Yaci Store with ledger-state calculation enabled, you may see logs similar to the example below, indicating
that address balance calculation is active â€” which is required for ledger-state calculation.

```
 # of blocks written: 100, Time taken: 25 ms
Block No: 4746  , Era: Shelley
### Starting account balance calculation upto block: 4846 ###
 	Total Stake Address Balance records 0, Time taken to save: 0
 	Time taken to delete stake address balance history: 0
### Total balance processing and saving time 1 ###

 # of blocks written: 100, Time taken: 28 ms
 Block No: 4846  , Era: Shelley
### Starting account balance calculation upto block: 4946 ###
 	Total Stake Address Balance records 0, Time taken to save: 0
 	Time taken to delete stake address balance history: 0
### Total balance processing and saving time 1 ###
```

#### ğŸ—„ï¸ PostgreSQL Configuration for Ledger-State (Optional but Recommended)

For optimal performance when running ledger-state calculation, especially on mainnet, you should tune your PostgreSQL configuration. While the default configuration will work, sync time will be significantly longer without these optimizations.

##### 1. Increase PostgreSQL Shared Memory

Edit `compose/postgres-compose.yml` and change the `shm_size` setting:

```yaml
shm_size: 4g  # Change from 2g to 4g (will work with 2g but sync time will be longer)
```

##### 2. Enable PostgreSQL Bulk Load Optimizations

Uncomment the following properties in `config/application-ledger-state.properties`:

```properties
## Reward Bulk Load Operations
store.adapot.reward-bulk-load-work-mem=1GB
store.adapot.reward-bulk-load-maintenance-work-mem=2GB

## Stake Snapshot Operations
store.adapot.stake-snapshot-work-mem=512MB

## DRep Distribution Snapshot Operations
store.governance-aggr.drep-dist-work-mem=512MB
```

##### 3. Restart the Application

After making these changes, restart Yaci Store:

```bash
./yaci-store.sh stop
./yaci-store.sh start
```

#### ğŸ› ï¸ Admin Operations

Use `admin-cli.sh` to run administrative tasks like applying indexes or rolling back to a specific epoch.

##### â–¶ï¸ Apply Indexes

```bash
./admin-cli.sh apply-indexes
```

> âš ï¸ This applies database indexes required for optimal read performance from API endpoints.

> ğŸ•’ **Important:** Only run this **after the full sync is complete**. Applying indexes early can significantly slow down the sync process.

##### ğŸ”„ Rollback

```bash
./admin-cli.sh rollback-data --epoch <epoch_no>
```

> âš ï¸ **Important:** Before performing rollback, you must **stop Yaci Store** but keep **PostgreSQL running**. Use the following command to stop only Yaci Store:

```bash
./yaci-store.sh stop:yaci-store
```

> In interactive mode, you'll be prompted to confirm the rollback operation.

#### ğŸ“Š Monitoring (Prometheus + Grafana)

Use `monitoring.sh` to start or stop the monitoring stack.

##### âœ… Start monitoring services

```bash
./monitoring.sh start
```

* ğŸ“ **Prometheus**: [http://localhost:9090](http://localhost:9090)
* ğŸ“ **Grafana**: [http://localhost:3000](http://localhost:3000)
  Default login: `admin / changeme`

##### ğŸ›‘ Stop monitoring services

```bash
./monitoring.sh stop
```

##### Troubleshooting

<Callout type="warning">
**Grafana Permission Error**

If Grafana fails to start with the error:
```
grafana | mkdir: can't create directory '/var/lib/grafana/plugins': Permission denied
grafana | GF_PATHS_DATA='/var/lib/grafana' is not writable.
```

This is a permission issue with the Grafana data directory. Fix it by running:

```bash
sudo chown -R 472:472 ./grafana
```

The user ID `472` is the default Grafana user in the Docker container.
</Callout>

##### ğŸ” Accessing PostgreSQL

To connect to the PostgreSQL database running in Docker, you can use the included `psql.sh` script:

```bash
./psql.sh
```

This script opens an interactive `psql` session inside the running PostgreSQL container.

> ğŸ’¡ Make sure the Yaci Store stack is already running (`./yaci-store.sh start`) before using this script.

---

### 2. Yaci Store Zip Distribution (JARs)

Filename: `yaci-store-<version>.zip`

Includes:
- `yaci-store.jar`
- `yaci-store-ledger-state.jar`
- Config files (`application.properties`)

#### Pre-requisites

- Java 21 or Java 24 (Recommended)

You can use [sdkman](https://sdkman.io/) to install Java 21 or 24.

```bash
sdk install java 24.0.1-tem
sdk use java 24.0.1-tem
```

Check if JAVA_HOME env variable is set correctly:

```bash
echo $JAVA_HOME
```

#### Edit Config

- Edit `application.properties` to set the Cardano network and Database connection settings
- Check the following properties and update them accordingly
```
store.cardano.host=preview-node.world.dev.cardano.org
store.cardano.port=30002
store.cardano.protocol-magic=2
```

```
spring.datasource.url=jdbc:postgresql://localhost:5432/yaci_indexer?currentSchema=preview
spring.datasource.username=user
spring.datasource.password=password
```

#### Usage

- **To run Yaci Store (without ledger-state):**
  ```bash
  ./bin/start.sh
  ```

- **To enable ledger-state calculation with all other on-chain data:**
  ```bash
  ./bin/start.sh ledger-state
  ```

**If ledger state is enabled, verify the log message to ensure that ledger-state calculation is active**

While running Yaci Store with ledger-state calculation enabled, you may see logs similar to the example below, indicating
that address balance calculation is active â€” which is required for ledger-state calculation.

```
 # of blocks written: 100, Time taken: 25 ms
Block No: 4746  , Era: Shelley
### Starting account balance calculation upto block: 4846 ###
 	Total Stake Address Balance records 0, Time taken to save: 0
 	Time taken to delete stake address balance history: 0
### Total balance processing and saving time 1 ###

 # of blocks written: 100, Time taken: 28 ms
 Block No: 4846  , Era: Shelley
### Starting account balance calculation upto block: 4946 ###
 	Total Stake Address Balance records 0, Time taken to save: 0
 	Time taken to delete stake address balance history: 0
### Total balance processing and saving time 1 ###
```

#### 2.1 Apply Optional Indexes

After the initial sync is complete:

```bash
./bin/yaci-cli.sh
```

This launches the Admin CLI (`yaci-store-admin-cli.jar`). At the CLI prompt:

```bash
yaci-store> apply-indexes
```

---

### 3. Yaci Store Native (GraalVM) Distribution *(Preview)*

Native binaries are available under a separate release tag:
`<version>-native` (e.g., `2.0.0-beta4-native`)

#### Download Format

Look for platform-specific ZIP files in this format:

```text
yaci-store-<version>-<os>-<arch>-all.zip
```

Example:

```text
yaci-store-2.0.0-beta4-linux-x64-all.zip
```

> âš ï¸ Only use the ZIP files ending with `-all`.
> Ignore files ending with `n2c`.

#### Setup

1. Extract the ZIP.
2. Edit `config/application.properties` to configure:
   - Cardano network info (host/port/protocol magic)
   - PostgreSQL connection settings

3. Run the app:

```bash
./yaci-store
```

4. Run with ledger-state profile:

```bash
SPRING_PROFILES_ACTIVE=ledger-state ./yaci-store
```

---

## Known Issues or Limitations

1. **Performance of Reward Calculation on Mainnet**
   - Ledger-state calculations currently happen **during epoch transition**.
     That means **rewards paid in epoch X are calculated during the transition from epoch X-1 to X**.
   - On Mainnet, this takes around **15â€“30 minutes** per transition (depends on your PostgreSQL resources).
   - In a future release, we plan to start **reward calculation in epoch X-1 after the stability window**, similar to how the Haskell node works.
     This will reduce the computation load during epoch boundaries.

---

> **Note:**
>
> If you are running ledger-state calculation for mainnet, you should **tune your PostgreSQL configuration** for optimal performance. While the default config will work, sync time will be significantly longer without these optimizations.
>
> **For Docker Distribution users:** See the [PostgreSQL Configuration section](#ï¸-postgresql-configuration-for-ledger-state-optional-but-recommended) in the Docker setup instructions above.
>
> **For Standalone Distribution users (Zip or Native):**
> 1. Increase PostgreSQL shared memory to 4GB or more (minimum 2GB recommended)
> 2. Configure the following PostgreSQL-related properties in your application configuration (application-ledger-state.properties):
>    - `store.adapot.reward-bulk-load-work-mem=1GB`
>    - `store.adapot.reward-bulk-load-maintenance-work-mem=2GB`
>    - `store.adapot.stake-snapshot-work-mem=512MB`
>    - `store.governance-aggr.drep-dist-work-mem=512MB`
