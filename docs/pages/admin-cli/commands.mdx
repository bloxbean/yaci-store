import { Callout } from 'nextra/components'

# Index Management Commands

This guide covers database index management operations in the Yaci Store Admin CLI.

## Overview

The Admin CLI provides commands for managing database indexes, which are essential for optimal read performance. All commands are organized under the `db` command group.

## Commands

### apply-indexes

Applies the default indexes required for read operations.

**Syntax:**
```bash
apply-indexes [--skip-extra-indexes]
```

**Parameters:**

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `--skip-extra-indexes` | boolean | `false` | Skip applying additional optional indexes |

**Examples:**
```bash
# Apply all indexes (default + extra)
apply-indexes

# Apply only default indexes
apply-indexes --skip-extra-indexes
```

This command applies indexes from:
- `index.yml`: Default required indexes for read operations
- `extra-index.yml`: Additional optional indexes (unless `--skip-extra-indexes` is set)

### apply-extra-indexes

Applies only the additional optional read indexes.

**Syntax:**
```bash
apply-extra-indexes
```

**Example:**
```bash
apply-extra-indexes
```

### verify-indexes

Lists missing indexes by comparing database state with index definitions.

**Syntax:**
```bash
verify-indexes
```

**Example:**
```bash
verify-indexes
```

**Output when indexes are missing:**
```
The following indexes are not found from index.yml
    Table: transaction, Index: idx_transaction_slot
    Table: block, Index: idx_block_epoch
```

## Index Configuration

Index behavior is defined in YAML configuration files located in the `dbutils` component.

### Configuration Files

1. **`index.yml`**: Required indexes for basic read operations
2. **`extra-index.yml`**: Optional indexes for enhanced performance

### YAML Structure

```yaml
- table: "table_name"
  indexes:
    - name: "index_name"
      columns:
        - "column1"
        - "column2"
      type: "btree"        # optional
      excludes:            # optional
        - "mysql"
```

### Configuration Fields

| Field | Description | Required |
|-------|-------------|----------|
| `table` | Name of the database table | Yes |
| `indexes.name` | Name of the index to create | Yes |
| `indexes.columns` | List of columns in the index | Yes |
| `indexes.type` | Index type (e.g., btree, gin, hash) | No |
| `indexes.excludes` | List of database types to exclude this index from | No |

### Example Configuration

```yaml
# Single column index
- table: "transaction"
  indexes:
    - name: "idx_transaction_slot"
      columns:
        - "slot"

# Multi-column index
- table: "utxo"
  indexes:
    - name: "idx_utxo_address_slot"
      columns:
        - "address"
        - "slot"

# GIN index (PostgreSQL only, excluded from MySQL)
- table: "address_utxo"
  indexes:
    - name: "idx_address_utxo_amounts"
      columns:
        - "amounts"
      type: "gin"
      excludes:
        - "mysql"
```

## When to Apply Indexes

### After Initial Sync

```bash
# For fastest initial sync, apply indexes AFTER sync completes
apply-indexes
```

### After Database Restore

```bash
# Verify existing indexes
verify-indexes

# Apply missing indexes
apply-indexes
```

### Performance Optimization

```bash
# Apply extra indexes for better read performance
apply-extra-indexes
```

## Performance Considerations

### Storage Impact
- Indexes consume additional disk space
- Multi-column indexes use more space than single-column

### Write Performance
- More indexes = slower inserts/updates during sync
- Consider applying indexes after initial sync completes

### Read Performance
- Indexes significantly improve query response times (10-100x)
- Essential for API endpoints and user-facing applications

## Common Workflows

### Initial Setup

```bash
# 1. Complete database sync
# 2. Verify index state
verify-indexes

# 3. Apply all indexes
apply-indexes

# 4. Verify completion
verify-indexes
```

### Regular Maintenance

```bash
# Check and apply missing indexes
verify-indexes
apply-indexes
```

## Command Reference

| Command | Purpose | When to Use |
|---------|---------|-------------|
| `apply-indexes` | Apply default and extra indexes | After initial sync, after restore |
| `apply-indexes --skip-extra-indexes` | Apply only default indexes | When storage is limited |
| `apply-extra-indexes` | Apply only extra indexes | Performance optimization |
| `verify-indexes` | List missing indexes | Regular maintenance |

## Related Documentation

- [Rollback Operations](/admin-cli/rollback) - Database rollback commands
- [Store Configuration](/stores/configuration) - Store configuration options
- [Admin CLI Overview](/admin-cli/overview) - General Admin CLI information
