import { Callout } from 'nextra/components'

# Rollback Operations

This guide covers rollback operations in Yaci Store Admin CLI, allowing you to revert your database to a previous epoch.

## Overview

Yaci Store Admin CLI provides two rollback commands:

1. **`rollback-data`**: Rolls back all store data to a specific epoch
2. **`rollback-ledger-state-data`**: Rolls back only ledger state data (rewards, epoch stakes, etc.)

<Callout type="warning">
**Important**: Always backup your database before rollback. Rollback permanently deletes data and cannot be undone without a backup.
</Callout>

## Prerequisites

Before performing rollback:

1. **Backup your database**
2. **Stop the sync process**
3. **Check pruning status** (see [Pruning Warnings](#pruning-warnings))

## Commands

### rollback-data

Rolls back all store data to a specified epoch.

#### Syntax

```bash
rollback-data --epoch <epoch_number> [options]
```

#### Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `--epoch` | Required | Target epoch to rollback to (must be valid and ≤ current max epoch) |
| `--event-publisher-id` | Optional | Event Publisher ID (default: 1) |
| `--rollback-files` | Optional | Comma-separated YAML config files (default: rollback.yml) |

#### Manual Rollback Point Parameters

<Callout type="info">
Use these **only** when the `block` table is not available. If block table exists, the command will fail.
</Callout>

| Parameter | Description |
|-----------|-------------|
| `--block` | Block number for rollback point |
| `--block-hash` | Block hash for rollback point |
| `--slot` | Slot number for rollback point |
| `--era` | Era for rollback point |

#### Examples

**Basic rollback:**
```bash
rollback-data --epoch 500
```

**With custom configuration:**
```bash
rollback-data --epoch 500 --rollback-files "custom-rollback.yml"
```

**Manual rollback point (when block table unavailable):**
```bash
rollback-data --epoch 500 \
  --block 10537200 \
  --block-hash "a5c72a0e74cf..." \
  --slot 76667163 \
  --era 3
```

### rollback-ledger-state-data

Rolls back only ledger state aggregation data.

#### Syntax

```bash
rollback-ledger-state-data --epoch <epoch_number>
```

#### Example

```bash
rollback-ledger-state-data --epoch 500
```

#### What Gets Rolled Back

- `adapot`: Staking pool aggregate data
- `adapot_jobs`: Job status (updated to 'STARTED')
- `epoch_stake`: Epoch stake snapshots
- `reward`, `reward_rest`, `unclaimed_reward_rest`: Reward records
- `drep_dist`: DRep stake distribution
- `gov_action_proposal_status`: Governance proposal statuses
- `epoch_param`: Epoch parameters
- `gov_epoch_activity`, `committee_state`: Governance data

<Callout type="info">
This command safely rolls back ledger state without affecting core blockchain data. It updates `adapot_jobs` status to allow re-processing.
</Callout>

## Configuration

### Rollback YAML Files

Rollback behavior is defined in YAML files:

1. **`rollback.yml`**: All store tables
2. **`rollback-ledger-state.yml`**: Ledger state tables only

#### YAML Structure

```yaml
rollback:
  tables:
    - name: "table_name"
      operation: "DELETE"  # or "UPDATE"
      condition:
        type: "slot"       # or "epoch"
        column: "slot"
        operator: ">"
        offset: 0          # optional
      update_set:          # for UPDATE only
        - column: "status"
          value: "'STARTED'"
```

#### Configuration Fields

| Field | Description | Values |
|-------|-------------|--------|
| `name` | Table name | Any valid table |
| `operation` | Rollback operation | `DELETE`, `UPDATE` |
| `condition.type` | Condition check type | `slot`, `epoch` |
| `condition.column` | Column to check | Column name |
| `condition.operator` | Comparison operator | `>`, `≥`, `<`, `≤`, `=` |
| `condition.offset` | Offset to apply | Integer (optional) |
| `update_set` | Columns to update | Array (for UPDATE) |

#### Example Configuration

```yaml
rollback:
  tables:
    # Delete blocks after rollback slot
    - name: "block"
      operation: "DELETE"
      condition:
        type: "slot"
        column: "slot"
        operator: ">"

    # Delete epoch stakes
    - name: "epoch_stake"
      operation: "DELETE"
      condition:
        type: "epoch"
        column: "epoch"
        operator: ">="
        offset: -1

    # Update job status
    - name: "adapot_jobs"
      operation: "UPDATE"
      condition:
        type: "epoch"
        column: "epoch"
        operator: ">="
      update_set:
        - column: "status"
          value: "'STARTED'"
```

### Application Properties

Configure in `application.yml`:

```yaml
store:
  admin-cli:
    db:
      rollback:
        rollback-files: rollback.yml
        # Manual rollback point (use only when block table unavailable)
        # point:
        #   block: 10537200
        #   block-hash: "a5c72a0e74cf..."
        #   slot: 76667163
        #   era: 3
```

## Pruning Warnings

If pruning is enabled, Admin CLI displays warnings before rollback. Pruning limits rollback capability.

### Impact by Pruning Type

#### UTXO Pruning
```properties
store.utxo.pruning-enabled=true
```
- Historical UTXOs may be deleted
- Can only rollback to points AFTER last pruning

#### Transaction Pruning
```properties
store.transaction.pruning-enabled=true
```
- Transaction and witness records may be deleted
- Historical data may be incomplete after rollback

#### Reward Pruning
```properties
store.adapot.reward-pruning-enabled=true
```
- Withdrawn reward records may be pruned
- Reward history may be incomplete

#### Epoch Stake Pruning
```properties
store.adapot.epoch-stake-pruning-enabled=true
```
- Old epoch stake records may be deleted
- Can only rollback to recent epochs

#### Account Balance Pruning
```properties
store.account.pruning-enabled=true
```
- Historical balance records may be pruned
- Balance history may be incomplete

<Callout type="warning">
**Rollback Risks with Pruning:**
1. Historical data needed for rollback may be permanently deleted
2. Application may fail to start after rollback
3. You can only safely rollback to points AFTER last pruning operation
4. Consider disabling pruning before rollback
</Callout>

## Validation and Safety

Admin CLI performs validation before rollback:

### 1. Epoch Validation

- Must be greater than 0
- Must be ≤ current maximum epoch in database

### 2. Mutually Exclusive Options

Manual rollback point parameters should NOT be used when block table exists.

**Error if violated:**
```
Error: Manual rollback point should not be provided when block table is available.
Use: rollback-data --epoch 500
```

### 3. Rollback Action Verification

- Verifies all configured tables exist
- Validates SQL statements
- Checks configuration format

## How Rollback Works

### Process Flow

1. **Validation**: Validate epoch, check options, verify pruning config
2. **Verification**: Verify tables exist, validate rollback actions
3. **Execution**: Determine rollback point, generate SQL, execute actions
4. **Completion**: Report success/failure

### Rollback Point Determination

**With Block Table (Normal):**
- Query block table for last block of target epoch
- Extract: slot, block number, block hash, era

**Without Block Table (Manual):**
- Use provided parameters or configuration
- Must provide all required values

### SQL Generation

**DELETE operations:**
```sql
DELETE FROM table_name WHERE column > rollback_slot
```

**UPDATE operations:**
```sql
UPDATE table_name SET status = 'STARTED' WHERE epoch >= rollback_epoch
```

## Common Use Cases

### Chain Reorganization

```bash
# Rollback to safe epoch before fork
rollback-data --epoch 450
# Restart sync to follow correct chain
```

### Data Correction

```bash
# Rollback to last known good epoch
rollback-data --epoch 480
# Fix issues and restart sync
```

### Ledger State Re-computation

```bash
# Rollback only ledger state
rollback-ledger-state-data --epoch 500
# Restart application to reprocess
```

## Best Practices

### 1. Always Backup

```bash
# PostgreSQL
pg_dump -h localhost -U username -d yaci_store > backup_$(date +%Y%m%d).sql

# MySQL
mysqldump -h localhost -u username -p yaci_store > backup_$(date +%Y%m%d).sql
```

### 2. Disable Pruning Before Rollback

```properties
store.utxo.pruning-enabled=false
store.transaction.pruning-enabled=false
store.adapot.reward-pruning-enabled=false
store.adapot.epoch-stake-pruning-enabled=false
store.account.pruning-enabled=false
```

### 3. Verify Indexes After Rollback

```bash
verify-indexes
# If needed:
apply-indexes
```

### 4. Test in Non-Production First

Always test rollback in development/staging before production.

### 5. Know Your Safe Rollback Window

With pruning enabled:
```
Safe Rollback Epoch = Current Epoch - Pruning Interval
```

## Summary

Key points:

- Two commands: `rollback-data` (full) and `rollback-ledger-state-data` (ledger only)
- Always backup before rollback
- Pruning limits rollback capabilities
- Use epoch-based rollback when block table exists
- Manual rollback point only when block table unavailable
- Verify indexes after rollback

For more information:
- [Admin CLI Overview](/admin-cli/overview)
- [Index Management](/admin-cli/commands)
- [Installation](/admin-cli/installation)
